name: CI - Multi-System Parallel Testing

on:
  push:
    branches: [ main, master, develop, 'feature/**' ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ============================================
  # LAYER A CORE (CrÃ­tico - Siempre corre primero)
  # ============================================
  layer-a-core:
    name: ðŸ”¬ Layer A Core
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
    
    - name: Run Layer A Core Tests
      run: npm run test:layer-a:core -- --reporter=verbose
      
    - name: Upload Layer A coverage
      if: github.ref == 'refs/heads/main'
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/lcov.info
        flags: layer-a-core
        name: layer-a-core

  # ============================================
  # LAYER B SEMANTIC (DespuÃ©s de Layer A)
  # ============================================
  layer-b-semantic:
    name: ðŸ§  Layer B Semantic
    runs-on: ubuntu-latest
    needs: layer-a-core
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
    
    - name: Run Layer B Semantic Tests
      run: npm run test:layer-b -- --reporter=verbose
      continue-on-error: true  # Allow failures during development
    
    - name: Upload Layer B coverage
      if: always() && github.ref == 'refs/heads/main'
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage/lcov.info
        flags: layer-b-semantic
        name: layer-b-semantic

  # ============================================
  # LAYER B MODULES (Paralelo - por mÃ³dulo)
  # ============================================
  layer-b-modules:
    name: ðŸ§© Layer B - ${{ matrix.module }}
    runs-on: ubuntu-latest
    needs: layer-b-semantic
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    strategy:
      fail-fast: false
      matrix:
        module: 
          - validators
          - schema-validator
          - metadata-contract
          - issue-detectors
          - project-analyzer
          - llm-analyzer
          - prompt-engine
          - lineage-validator
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
    
    - name: Run ${{ matrix.module }} Tests
      run: npm test -- --run tests/unit/layer-b-semantic/${{ matrix.module }} --reporter=verbose
      continue-on-error: true

  # ============================================
  # CONTRACT TESTS (Obligatorio para todos)
  # ============================================
  contracts:
    name: ðŸ“‹ Contract Tests
    runs-on: ubuntu-latest
    needs: layer-a-core
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
    
    - name: Run Contract Tests
      run: npm run test:contracts -- --reporter=verbose

  # ============================================
  # EXTRACTOR TESTS (Por lenguaje - Paralelo)
  # ============================================
  extractors:
    name: ðŸ”§ Extractor - ${{ matrix.extractor }}
    runs-on: ubuntu-latest
    needs: contracts
    strategy:
      fail-fast: false
      matrix:
        extractor: [javascript]

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
    
    - name: Run ${{ matrix.extractor }} Extractor Tests
      run: npm run test:layer-a:extractor:${{ matrix.extractor }} -- --reporter=verbose
      continue-on-error: true

  # ============================================
  # INTEGRATION TESTS (DespuÃ©s de unit)
  # ============================================
  integration:
    name: ðŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [layer-a-core, layer-b-semantic, contracts]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
    
    - name: Run Integration Tests
      run: npm run test:integration -- --reporter=verbose

  # ============================================
  # E2E TESTS (Solo en main/develop)
  # ============================================
  e2e:
    name: ðŸŽ­ E2E Tests
    runs-on: ubuntu-latest
    needs: [integration]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
    
    - name: Run E2E Tests
      run: npm run test:e2e -- --reporter=verbose
      continue-on-error: true

  # ============================================
  # STRUCTURAL VALIDATION
  # ============================================
  validate:
    name: âœ… Structural Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
    
    - name: Validate Project Structure
      run: |
        echo "Validating OmnySys structure..."
        test -d src/layer-a-static || exit 1
        test -d src/layer-b-semantic || exit 1
        test -d src/layer-c-memory || exit 1
        test -d src/core || exit 1
        test -f tests/ARCHITECTURE_TESTING.md || exit 1
        echo "âœ… Structure valid"
    
    - name: Check for broken imports
      run: |
        node scripts/detect-broken-imports.js
      continue-on-error: true
    
    - name: Run syntax validation
      run: npm run validate

  # ============================================
  # PERFORMANCE (Solo en main)
  # ============================================
  performance:
    name: âš¡ Performance
    runs-on: ubuntu-latest
    needs: [integration]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci --ignore-scripts
    
    - name: Run Performance Tests
      run: npm run test:performance -- --reporter=verbose
      continue-on-error: true

  # ============================================
  # SUMMARY (NotificaciÃ³n final)
  # ============================================
  summary:
    name: ðŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [layer-a-core, layer-b-semantic, layer-b-modules, contracts, extractors, integration, validate]
    if: always()
    
    steps:
    - name: Summary
      run: |
        echo "========================================="
        echo "ðŸ“Š CI Summary"
        echo "========================================="
        echo "Layer A Core: ${{ needs.layer-a-core.result }}"
        echo "Layer B Semantic: ${{ needs.layer-b-semantic.result }}"
        echo "Layer B Modules: ${{ needs.layer-b-modules.result }}"
        echo "Contracts: ${{ needs.contracts.result }}"
        echo "Extractors: ${{ needs.extractors.result }}"
        echo "Integration: ${{ needs.integration.result }}"
        echo "Validation: ${{ needs.validate.result }}"
        echo "========================================="
