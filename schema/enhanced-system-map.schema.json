{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://omnysys.dev/schemas/enhanced-system-map.json",
  "title": "Enhanced System Map",
  "description": "Schema for OmnySys enhanced system map combining static and semantic analysis",
  "type": "object",
  "required": ["metadata", "files"],
  "properties": {
    "metadata": {
      "type": "object",
      "required": ["version", "generated", "analyzers"],
      "properties": {
        "version": {
          "type": "string",
          "description": "Schema version (semver)",
          "pattern": "^\\d+\\.\\d+\\.\\d+$"
        },
        "generated": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of generation"
        },
        "analyzers": {
          "type": "object",
          "required": ["static"],
          "properties": {
            "static": {
              "type": "string",
              "description": "Static analyzer version (e.g., 'layer-a-v0.3.3')"
            },
            "semantic": {
              "type": "string",
              "description": "Semantic analyzer version (e.g., 'layer-b-lfm2.5-thinking-v1')"
            }
          }
        },
        "project": {
          "type": "object",
          "properties": {
            "name": { "type": "string" },
            "path": { "type": "string" },
            "fileCount": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },
    "files": {
      "type": "object",
      "description": "Map of file paths to file analysis",
      "additionalProperties": {
        "$ref": "#/definitions/FileAnalysis"
      }
    },
    "connectionIndex": {
      "type": "object",
      "description": "Index of semantic connections for fast lookups",
      "properties": {
        "by_type": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": { "type": "string" }
          }
        },
        "by_file": {
          "type": "object",
          "additionalProperties": {
            "type": "array",
            "items": { "type": "string" }
          }
        },
        "by_severity": {
          "type": "object",
          "properties": {
            "critical": { "type": "array", "items": { "type": "string" } },
            "high": { "type": "array", "items": { "type": "string" } },
            "medium": { "type": "array", "items": { "type": "string" } },
            "low": { "type": "array", "items": { "type": "string" } }
          }
        }
      }
    }
  },
  "definitions": {
    "FileAnalysis": {
      "type": "object",
      "required": ["path", "imports", "exports"],
      "properties": {
        "path": {
          "type": "string",
          "description": "Absolute or normalized file path"
        },
        "displayPath": {
          "type": "string",
          "description": "Human-readable relative path"
        },
        "imports": {
          "type": "array",
          "items": { "$ref": "#/definitions/ImportStatement" }
        },
        "exports": {
          "type": "array",
          "items": { "$ref": "#/definitions/Export" }
        },
        "calls": {
          "type": "array",
          "items": { "$ref": "#/definitions/Call" }
        },
        "identifierRefs": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Referenced identifiers (constants, variables)"
        },
        "usedBy": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files that depend on this file"
        },
        "dependsOn": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Files this file depends on"
        },
        "semanticConnections": {
          "type": "array",
          "items": { "$ref": "#/definitions/SemanticConnection" },
          "description": "Non-obvious connections detected by AI"
        },
        "sideEffects": {
          "$ref": "#/definitions/SideEffects"
        },
        "riskScore": {
          "$ref": "#/definitions/RiskScore"
        },
        "analysis": {
          "$ref": "#/definitions/AnalysisStatus"
        }
      }
    },
    "ImportStatement": {
      "type": "object",
      "required": ["source", "specifiers"],
      "properties": {
        "source": {
          "type": "string",
          "description": "Import source (e.g., './file', 'lodash')"
        },
        "specifiers": {
          "type": "array",
          "items": { "$ref": "#/definitions/ImportSpecifier" }
        },
        "resolved": {
          "type": ["string", "null"],
          "description": "Resolved file path (null if unresolved)"
        }
      }
    },
    "ImportSpecifier": {
      "type": "object",
      "required": ["type"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["named", "default", "namespace", "side-effect"],
          "description": "Type of import"
        },
        "imported": {
          "type": "string",
          "description": "Imported name (for named imports)"
        },
        "local": {
          "type": "string",
          "description": "Local binding name"
        }
      }
    },
    "Export": {
      "type": "object",
      "required": ["type", "name"],
      "properties": {
        "type": {
          "type": "string",
          "enum": ["function", "const", "let", "var", "class", "default"],
          "description": "Type of export"
        },
        "name": {
          "type": "string",
          "description": "Exported name"
        }
      }
    },
    "Call": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Function name or object.method"
        },
        "line": {
          "type": "integer",
          "minimum": 1,
          "description": "Line number of call"
        }
      }
    },
    "SemanticConnection": {
      "type": "object",
      "required": ["id", "type", "target", "reason", "confidence"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique connection ID (e.g., 'conn_1')"
        },
        "type": {
          "type": "string",
          "enum": ["shared_state", "event_listener", "callback", "side_effect", "global_access", "mutation"],
          "description": "Type of semantic connection"
        },
        "target": {
          "type": "string",
          "description": "Target file path"
        },
        "reason": {
          "type": "string",
          "description": "Human-readable explanation"
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Confidence score (0-1)"
        },
        "severity": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"],
          "description": "Severity of connection"
        },
        "sourceLocations": {
          "type": "array",
          "items": { "$ref": "#/definitions/CodeLocation" },
          "description": "Locations in source file"
        },
        "targetLocations": {
          "type": "array",
          "items": { "$ref": "#/definitions/CodeLocation" },
          "description": "Locations in target file"
        },
        "evidence": {
          "type": "object",
          "properties": {
            "sourceCode": { "type": "string" },
            "targetCode": { "type": "string" }
          }
        },
        "detectedBy": {
          "type": "string",
          "description": "Analyzer that detected this (e.g., 'lmf2.5-thinking')"
        },
        "detectedAt": {
          "type": "string",
          "format": "date-time",
          "description": "Detection timestamp"
        },
        "validated": {
          "type": "boolean",
          "description": "Whether manually validated"
        }
      }
    },
    "CodeLocation": {
      "type": "object",
      "required": ["line"],
      "properties": {
        "function": {
          "type": "string",
          "description": "Function name (if inside function)"
        },
        "line": {
          "type": "integer",
          "minimum": 1,
          "description": "Line number"
        },
        "column": {
          "type": "integer",
          "minimum": 0,
          "description": "Column number"
        }
      }
    },
    "SideEffects": {
      "type": "object",
      "properties": {
        "hasGlobalAccess": {
          "type": "boolean",
          "description": "Accesses global variables (window, globalThis)"
        },
        "modifiesDOM": {
          "type": "boolean",
          "description": "Modifies DOM (document, querySelector)"
        },
        "makesNetworkCalls": {
          "type": "boolean",
          "description": "Makes network requests (fetch, XMLHttpRequest)"
        },
        "usesLocalStorage": {
          "type": "boolean",
          "description": "Uses localStorage/sessionStorage"
        },
        "accessesWindow": {
          "type": "boolean",
          "description": "Accesses window object"
        },
        "modifiesGlobalState": {
          "type": "boolean",
          "description": "Modifies global/shared state"
        },
        "hasEventListeners": {
          "type": "boolean",
          "description": "Registers event listeners"
        },
        "usesTimers": {
          "type": "boolean",
          "description": "Uses setTimeout/setInterval"
        }
      }
    },
    "RiskScore": {
      "type": "object",
      "required": ["total"],
      "properties": {
        "total": {
          "type": "number",
          "minimum": 0,
          "maximum": 10,
          "description": "Total risk score (0-10)"
        },
        "breakdown": {
          "type": "object",
          "properties": {
            "staticComplexity": {
              "type": "number",
              "minimum": 0,
              "maximum": 10
            },
            "semanticConnections": {
              "type": "number",
              "minimum": 0,
              "maximum": 10
            },
            "hotspotRisk": {
              "type": "number",
              "minimum": 0,
              "maximum": 10
            },
            "sideEffectRisk": {
              "type": "number",
              "minimum": 0,
              "maximum": 10
            }
          }
        }
      }
    },
    "AnalysisStatus": {
      "type": "object",
      "required": ["staticAnalyzed"],
      "properties": {
        "staticAnalyzed": {
          "type": "boolean",
          "description": "Whether static analysis completed"
        },
        "semanticAnalyzed": {
          "type": "boolean",
          "description": "Whether semantic analysis completed"
        },
        "lastSemanticAnalysis": {
          "type": ["string", "null"],
          "format": "date-time",
          "description": "Last semantic analysis timestamp"
        },
        "needsReanalysis": {
          "type": "boolean",
          "description": "Whether file changed since last analysis"
        },
        "errors": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": { "type": "string" },
              "message": { "type": "string" },
              "timestamp": { "type": "string", "format": "date-time" }
            }
          }
        }
      }
    }
  }
}
