# v0.9.19 — Runtime Bug Fix Round 2

**Date:** 2026-02-18  
**Type:** Bug Fix  
**Scope:** Layer A parser, data-flow visitors, Layer B prompt builder

## Context

After deploying v0.9.18 and restarting the MCP server, 3 new runtime errors remained visible in the startup logs. This release eliminates them.

## Bugs Fixed

### Bug 1 — `pipelineOperator` proposal `minimal` crashes `omnysystem.js` scan

**Files:**
- `src/layer-a-static/parser/config.js`
- `src/layer-a-static/extractors/atomic/index.js`
- `src/layer-a-static/analyses/tier3/event-detector/constants.js`

**Root cause:** `omnysystem.js` uses `|>` with `#` topic token (Hack proposal). All three parser configs had `{ proposal: 'minimal' }` which does not support `#`. Babel would throw `Unexpected token` when scanning this file.

**Fix:** Changed to `{ proposal: 'hack', topicToken: '#' }` in all three parser configurations.

### Bug 2 — `Cannot read properties of undefined (reading 'map')` in data-flow

**Files:**
- `src/layer-a-static/extractors/data-flow/core/graph-builder.js`
- `src/layer-a-static/extractors/data-flow/visitors/output-extractor/extractors/shape-inferer.js`

**Root cause:** `GraphBuilder.connectNodes()` and `toVisualFormat()` iterated/mapped over `node.inputs` without null guard. When `...nodeData.metadata` spread in `addNode()` could override the `inputs: nodeData.inputs || []` default with an `undefined` metadata property, the guard was bypassed. Similarly, `inferShape()` accessed `node.properties` without `|| []` fallback.

**Fix:**
- `connectNodes()`: `for (const input of (node.inputs || []))`
- `toVisualFormat()`: `(node.inputs || []).map(...)`
- `inferShape()`: `(node.properties || []).filter(...).map(...)`

### Bug 3 — `Error building prompt for [file]:` logs empty string

**File:** `src/layer-b-semantic/llm-analyzer/prompt-builder.js`

**Root cause:** The catch block logged `error.message`, which is `""` (empty string) for `TypeError` instances thrown by `new Error(...)` in some Node.js internals.

**Fix:** Changed to `error.stack ?? error.message ?? String(error)` to always expose the full error detail.

## Test Coverage

- Updated: `tests/unit/layer-a-static/extractors/data-flow-parser-plugins.test.js` — covers hack proposal in all 3 parser configs
- New: `tests/unit/layer-b-semantic/llm-analyzer/prompt-builder.test.js` — covers error logging with non-message errors

## Files Changed

| File | Change |
|------|--------|
| `src/layer-a-static/parser/config.js` | `minimal` → `hack` pipeline proposal |
| `src/layer-a-static/extractors/atomic/index.js` | Added `pipelineOperator hack` to PARSER_CONFIG |
| `src/layer-a-static/analyses/tier3/event-detector/constants.js` | `minimal` → `hack` pipeline proposal |
| `src/layer-a-static/extractors/data-flow/core/graph-builder.js` | Null-safety on `node.inputs` |
| `src/layer-a-static/extractors/data-flow/visitors/output-extractor/extractors/shape-inferer.js` | Null-safety on `node.properties` |
| `src/layer-b-semantic/llm-analyzer/prompt-builder.js` | Full error detail in catch log |
