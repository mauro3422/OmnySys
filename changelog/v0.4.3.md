# CHANGELOG - OmnySys v0.4.3

## [0.4.3] - 2026-02-03

### üéØ RESUMEN EJECUTIVO

Versi√≥n **PATCH**: Correcci√≥n de bugs cr√≠ticos y mejoras de estabilidad del sistema.

- üîó **Batch Processor Conectado**: Fix del flujo FileWatcher ‚Üí Queue ‚Üí Worker
- üíæ **State Manager At√≥mico**: Escritura at√≥mica para prevenir corrupci√≥n de estado
- üß† **Cache LRU**: L√≠mites de memoria para QueryCache y LLMCache
- üßπ **MCP Cleanup**: Limpieza de recursos al cerrar servidor
- üîÑ **Rollback de An√°lisis**: Restauraci√≥n autom√°tica si el an√°lisis falla
- üéØ **LLM Unificado**: Comportamiento consistente entre comandos

---

## üêõ BUGS CORREGIDOS

### P0: Batch Processor Dead End

**Problema**: El BatchProcessor recib√≠a cambios del FileWatcher pero no los enviaba a la AnalysisQueue.

**Archivo**: `src/core/unified-server.js`

**Fix**:
```javascript
// Nuevo callback processChange conecta a la queue
this.batchProcessor = new BatchProcessor({
  processChange: async (change) => {
    const priority = this.calculateChangePriority(change);
    this.queue.enqueue(change.filePath, priority);
    // Notifica a WebSocket clients
  }
});
```

**Flujo corregido**:
```
File Watcher ‚Üí BatchProcessor ‚Üí AnalysisQueue ‚Üí AnalysisWorker ‚Üí indexProject
                    ‚Üì
              WebSocket notify
```

---

### P0: State Manager Race Condition

**Problema**: `fs.writeFile` no es at√≥mico; requests simult√°neos pod√≠an corromper el estado.

**Archivo**: `src/core/state-manager.js`

**Fix**:
```javascript
// Escritura at√≥mica (write temp ‚Üí rename)
async write(state) {
  return this.writeLock = this.writeLock.then(async () => {
    const tempPath = `${this.filePath}.tmp.${Date.now()}.${process.pid}`;
    await fs.writeFile(tempPath, JSON.stringify(state, null, 2));
    await fs.rename(tempPath, this.filePath); // At√≥mico
  });
}
```

**Beneficio**: Estado consistente incluso con m√∫ltiples requests simult√°neos.

---

### P0: QueryCache Sin L√≠mite

**Problema**: El cache en RAM crec√≠a indefinidamente. Proyectos grandes pod√≠an causar OutOfMemory.

**Archivo**: `src/layer-c-memory/query-cache.js`

**Fix**:
```javascript
// L√≠mite de 1000 entradas con LRU eviction
constructor(ttlMinutes = 5, maxEntries = 1000) {
  this.cache = new Map();
  this.maxEntries = maxEntries;
}

set(key, data) {
  // LRU: eliminar entrada m√°s antigua si se alcanza el l√≠mite
  if (this.cache.size >= this.maxEntries) {
    const oldestKey = this.cache.keys().next().value;
    this.cache.delete(oldestKey);
    this.stats.evictions++;
  }
  // ...
}
```

---

### P0: LLMCache Sin Rotaci√≥n

**Problema**: Cada cambio de c√≥digo generaba una nueva entrada de cache. Sin l√≠mite, pod√≠a llenar el disco.

**Archivo**: `src/layer-b-semantic/llm-cache.js`

**Fix**:
```javascript
// Rotaci√≥n FIFO (mantiene 500 entradas m√°ximo)
constructor(cacheDir = '.OmnySystemData/llm-cache', maxEntries = 500) {
  this.maxEntries = maxEntries;
}

async rotateCacheIfNeeded() {
  // Elimina los archivos m√°s antiguos si excede el l√≠mite
  // Mantiene el 80% m√°s reciente
}
```

---

### P0: MCP Server Memory Leak

**Problema**: `setInterval` sin cleanup. El proceso no pod√≠a terminar gracefulmente.

**Archivo**: `src/layer-c-memory/mcp-server.js`

**Fix**:
```javascript
constructor() {
  this.statsInterval = null; // Track del interval
}

// Cleanup en SIGINT
process.on('SIGINT', () => {
  if (server.statsInterval) clearInterval(server.statsInterval);
});

// M√©todo stop() para cleanup program√°tico
async stop() {
  if (this.statsInterval) clearInterval(this.statsInterval);
}
```

---

### P1: WebSocket Subscriptions Memory Leak

**Problema**: El Set `subscriptions` no se limpiaba al cerrar conexiones.

**Archivo**: `src/core/websocket/websocket-manager.js`

**Fix**:
```javascript
handleClose() {
  const subCount = this.subscriptions.size;
  this.subscriptions.clear(); // Limpieza expl√≠cita
  this.manager.removeClient(this.id);
}
```

---

### P1: Comportamiento LLM Inconsistente

**Problema**: `consolidate()` fallaba sin LLM, pero `serve()` intentaba iniciarlo autom√°ticamente.

**Archivo**: `omnysystem.js`

**Fix**:
```javascript
// Nueva funci√≥n unificada
async function ensureLLMAvailable(aiConfig, options = {}) {
  const { required = true, autoStart = true, maxWaitSeconds = 60 } = options;
  // ... intenta iniciar, espera, o falla seg√∫n configuraci√≥n
}

// Uso en ambos comandos:
const llmStatus = await ensureLLMAvailable(aiConfig, { 
  required: true, 
  autoStart: true 
});
```

---

### P1: Rollback de An√°lisis Fallido

**Problema**: Si el an√°lisis fallaba, el sistema pod√≠a quedar con datos parciales/corruptos.

**Archivo**: `src/core/analysis-worker.js`

**Fix**:
```javascript
async analyze(job) {
  // Guardar an√°lisis anterior
  const previousAnalysis = await getFileAnalysis(this.rootPath, job.filePath);
  
  try {
    await indexProject(...);
  } catch (error) {
    // Rollback: restaurar an√°lisis anterior
    if (previousAnalysis) {
      await saveFileAnalysis(this.rootPath, job.filePath, previousAnalysis);
    }
    throw error;
  }
}
```

---

## üìä RESUMEN DE CAMBIOS

| Archivo | Cambios | Descripci√≥n |
|---------|---------|-------------|
| `omnysystem.js` | +175/-54 | Funci√≥n `ensureLLMAvailable()` unificada |
| `src/core/unified-server.js` | +255/-35 | BatchProcessor conectado a Queue |
| `src/core/state-manager.js` | +63/-17 | Escritura at√≥mica con lock |
| `src/core/analysis-worker.js` | +25/-0 | Rollback en caso de fallo |
| `src/core/websocket/websocket-manager.js` | +10/-1 | Cleanup de subscriptions |
| `src/layer-c-memory/query-cache.js` | +21/-4 | LRU eviction (max 1000 entries) |
| `src/layer-b-semantic/llm-cache.js` | +46/-3 | Rotaci√≥n FIFO (max 500 entries) |
| `src/layer-c-memory/mcp-server.js` | +27/-2 | Cleanup de intervals |
| `src/layer-a-static/indexer.js` | +5/-2 | Par√°metro skipLLM propagado |
| `src/layer-a-static/scanner.js` | +2/-1 | Fix menor |
| `src/core/file-watcher.js` | +3/-1 | Fix menor |

**Total**: +528 l√≠neas, -104 l√≠neas, 11 archivos modificados

---

## üß™ VALIDACI√ìN

```bash
# Todos los archivos pasan validaci√≥n sint√°ctica ‚úÖ
node --check src/core/unified-server.js
node --check src/core/state-manager.js
node --check src/core/analysis-worker.js
node --check src/core/websocket/websocket-manager.js
node --check src/layer-c-memory/query-cache.js
node --check src/layer-b-semantic/llm-cache.js
node --check src/layer-c-memory/mcp-server.js
node --check omnysystem.js
```

---

## üó∫Ô∏è ROADMAP ACTUALIZADO

### v0.4.3 (Actual) ‚úÖ
- [x] Batch Processor conectado a Queue
- [x] State Manager at√≥mico
- [x] Cache LRU con l√≠mites
- [x] MCP cleanup
- [x] Rollback de an√°lisis
- [x] LLM behavior unificado

### v0.5.0 (Pr√≥ximo)
- [ ] Completar CSS-in-JS (emotion, theme-ui)
- [ ] Completar TypeScript (generics, type guards)
- [ ] Completar Redux/Context (providers, consumers)
- [ ] Activar Opci√≥n C: an√°lisis por funci√≥n

---

**Fin del changelog v0.4.3**
