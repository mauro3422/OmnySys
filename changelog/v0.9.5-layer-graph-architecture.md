# v0.9.5 - Layer Graph + Deuda TÃ©cnica

**Fecha**: 2026-02-18  
**Tipo**: Major Architecture Refactor  

---

## ğŸ› Bug Fixes (2026-02-18 - Session 2)

### Critical Fixes
- **`modify-operation.js`**: Import dinÃ¡mico de `path` incorrecto - `const { path } = await import('path')` retornaba undefined
- **`insert-operation.js`**: Mismo bug de import dinÃ¡mico
- **`delete-operation.js`**: Mismo bug de import dinÃ¡mico
- **`operation-executor.js`**: `prepareUndo()` llamado antes de `execute()` causando que undo/redo fallaran

### Null Safety Fixes
- **`path-utils.js`**: `detectPathFormat()` lanzaba error cuando `filePath` era undefined
- **`json-reader.js`**: No retornaba null cuando archivo no existe, lanzaba error
- **`single-file.js`**: `normalizeFilePath()` no manejaba undefined o empty strings
- **`recommendation-engine.js`**: Optional chaining para `.includes()` en mensaje undefined
- **`stats.js`**: Optional chaining para `.includes()` en mensaje undefined
- **`atoms-files-validator.js`**: Optional chaining para `.includes()` en mensaje undefined
- **`duplication-detector.js`**: Optional chaining para `.includes()` en mensaje undefined
- **`files-connections-validator.js`**: Optional chaining para `.includes()` en mensaje undefined

### Import Fixes
- **`atom-extractor.js`**: `extractPerformanceHints` usado pero no importado
- **`tier3/index.js`**: `RiskScorer` re-exportado pero no disponible localmente

### MCP Tool Fixes
- **`atomic-edit.js`**: `result.impact` undefined causando crash

---

## âœ… Tests: 101 â†’ 35 Skipped (-66 tests habilitados)

### Tests Fixed
| Archivo | Tests Fixed | CategorÃ­a |
|---------|-------------|-----------|
| `operations.test.js` | 23 | Atomic Editor operations |
| `consistency-validator.test.js` | 18 | Layer C validation |
| `atomic-editor.test.js` | 8 | Atomic Editor main |
| `orchestrator.test.js` | 5 | Core orchestrator |
| `impact-map.test.js` | 3 | MCP tools |
| `analyzer.test.js` | 4 | AI module |
| `llm-client.test.js` | 1 | AI module |
| `batch-analyzer.test.js` | 1 | AI module |
| `parallel-analyzer.test.js` | 1 | AI module |

### Remaining Skipped (35)
| CategorÃ­a | Cantidad | RazÃ³n |
|-----------|----------|-------|
| `SKIP: requires LLM server` | 21 | Necesitan servidor LLM real |
| `LIMITATION: node --check` | 2 | LimitaciÃ³n del validador de sintaxis |
| `BUG:` | 7 | Bugs pendientes de investigaciÃ³n |
| `TODO:` | 3 | Features no implementadas |
| `it.skipIf` condicionales | ~2 | Tests condicionales |

---

## ğŸ¯ Resumen

CreaciÃ³n de **Layer Graph** como capa dedicada del sistema de grafos, y limpieza de deuda tÃ©cnica en `core/`.

---

## âœ¨ Nuevo: Layer Graph

### CreaciÃ³n
- Nueva carpeta `src/layer-graph/` con estructura modular
- API pÃºblica unificada con 54 exports
- Namespaces: `types`, `algorithms`, `builders`, `query`, `resolvers`, `utils`, `persistence`

### Estructura
```
src/layer-graph/
â”œâ”€â”€ index.js              # API pÃºblica
â”œâ”€â”€ core/types.js         # SSOT
â”œâ”€â”€ algorithms/           # cycle-detector, impact-analyzer, transitive-deps
â”œâ”€â”€ builders/             # system-map, export-index, function-links, call-graph
â”œâ”€â”€ query/                # dependency-query, impact-query, call-graph-analyzer
â”œâ”€â”€ resolvers/            # function-resolver
â”œâ”€â”€ persistence/          # serialize, deserialize, delta
â””â”€â”€ utils/                # path-utils, counters
```

### ConsolidaciÃ³n
- 17 archivos dispersos en 9 ubicaciones â†’ centralizados en layer-graph
- Archivos movidos de:
  - `core/graph/`
  - `layer-a-static/pipeline/graph.js`
  - `layer-a-static/module-system/builders/`
  - `layer-a-static/extractors/metadata/call-graph.js`
  - `layer-c-memory/mcp/tools/lib/analysis/`
  - `layer-a-static/query/queries/`
  - `layer-a-static/module-system/queries/`

### Tests
- 21 tests unitarios (`tests/unit/layer-graph/`)
- 54 tests de contrato (`tests/contracts/layer-graph/`)
- **75 tests totales pasando**

### DocumentaciÃ³n
- `docs/02-architecture/layer-graph.md` - Arquitectura y pesos dinÃ¡micos
- `docs/02-architecture/code-physics.md` - VisiÃ³n de cÃ³digo como fÃ­sica
- `docs/02-architecture/data-by-layer.md` - Datos por layer
- `src/layer-graph/README.md` - DocumentaciÃ³n tÃ©cnica

---

## ğŸ§¹ Deuda TÃ©cnica Eliminada

### Wrappers Eliminados (4 archivos)
- `src/core/orchestrator.js` â†’ usar `#core/orchestrator/index.js`
- `src/core/file-watcher.js` â†’ usar `#core/file-watcher/index.js`
- `src/core/unified-cache-manager.js` â†’ usar `#core/unified-cache-manager/index.js`
- `src/core/unified-server.js` â†’ usar `#core/unified-server/index.js`

### Carpetas VacÃ­as Eliminadas (4)
- `src/core/handlers/` - Placeholder vacÃ­o
- `src/core/graph/` - Migrado a layer-graph
- `src/layer-a-static/cache/` - VacÃ­o
- `src/layer-a-static/storage/` - VacÃ­o (solo README)
- `src/core/tunnel-vision-detectors/` - VacÃ­o (carpeta duplicada)

### Imports Actualizados (3 archivos)
- `src/layer-c-memory/mcp/core/initialization/steps/cache-init-step.js`
- `src/layer-c-memory/mcp/core/initialization/steps/orchestrator-init-step.js`
- `tests/contracts/core/graph.contract.test.js`

---

## ğŸ“¦ ConfiguraciÃ³n

### package.json
- VersiÃ³n actualizada a `0.9.5`
- Nuevo import alias: `#layer-graph/*`
- Nuevos scripts: `test:layer-graph`, `test:layer-graph:contracts`

---

## ğŸ“Š MÃ©tricas

| MÃ©trica | Antes | DespuÃ©s |
|---------|-------|---------|
| Archivos en core/graph/ | 11 | 0 (migrado) |
| Archivos en layer-graph/ | 0 | 17 |
| Tests Layer Graph | 0 | 75 |
| Carpetas vacÃ­as | 5 | 0 |
| Wrappers duplicados | 4 | 0 |

---

## ğŸ”® PrÃ³ximos Pasos

1. Mover `core/storage/` â†’ `layer-c-memory/storage/`
2. Mover `layer-a-static/query/` â†’ `layer-c-memory/query/`
3. Unificar cache en `core/cache/`
4. Mover `layer-b-semantic/issue-detectors/` â†’ `layer-a-static/analyses/tier3/`

---

## ğŸ“š DocumentaciÃ³n Nueva

- `docs/02-architecture/layer-graph.md`
- `docs/02-architecture/code-physics.md`
- `docs/02-architecture/data-by-layer.md`
- `docs/06-reference/SYSTEM_STATUS.md`
- `docs/06-reference/CLEANUP_PLAN.md`
