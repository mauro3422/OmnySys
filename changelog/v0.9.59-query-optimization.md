# v0.9.59 - Query Optimization & Metadata Fixes

## Date: 2026-02-23

## Summary
Fixed metadata structure mismatch and optimized query loading for MCP tools to load only necessary atoms instead of all atoms.

---

## üêõ Bug Fixes

### Metadata Structure Fix
- **Issue**: `get_server_status` and other tools showed `totalFiles: 0, totalFunctions: 0`
- **Cause**: Migration to SQLite changed metadata structure from `metadata.metadata.totalFiles` to `metadata.stats.totalFiles` and `metadata.system_map_metadata`
- **Files Fixed**:
  - `status.js` - Fixed metadata access path
  - `analysis-checker.js` - Fixed metadata access
  - `decision-engine.js` - Fixed metadata access
  - `cache-manager.js` - Fixed metadata access
  - `status-tools.js` - Fixed metadata access
  - `analysis-manager.js` - Fixed metadata access
  - `project-query.js` - Added fallback to `system_map_metadata`

---

## ‚ö° Performance Optimization

### Smart Query Loading
Tools now load only necessary atoms instead of all atoms:

| Tool | Before | After |
|------|--------|-------|
| `trace-variable-impact.js` | Load all + filter | `getAtomsInFile()` + external relations |
| `trace-data-journey.js` | Load all + filter | `getAtomsInFile()` + external relations |
| `simulate-data-journey.js` | Load all + filter | `getAtomsInFile()` + external relations |
| `get-health-metrics.js` | Load all + filter | `getAtomsInFile()` if filePath provided |
| `suggest-refactoring.js` | Load all + filter | `getAtomsInFile()` if filePath provided |

### Enrichment with External Relations
- Added support to load external atoms (callers/callees from other files)
- This ensures trace tools have full visibility while keeping queries optimized

### SQLite Query Enhancement
- Added `ids` filter to `queryAtoms()` in `sqlite-query-operations.js`
- Enables efficient loading of specific atoms by ID list

---

## üìÅ Files Changed

```
src/core/unified-server/initialization/analysis-manager.js
src/core/unified-server/initialization/cache-manager.js
src/core/unified-server/tools/status-tools.js
src/layer-c-memory/mcp/core/analysis-checker.js
src/layer-c-memory/mcp/core/analysis-checker/decision-engine.js
src/layer-c-memory/mcp/tools/get-health-metrics.js
src/layer-c-memory/mcp/tools/simulate-data-journey.js
src/layer-c-memory/mcp/tools/status.js
src/layer-c-memory/mcp/tools/suggest-refactoring.js
src/layer-c-memory/mcp/tools/trace-data-journey.js
src/layer-c-memory/mcp/tools/trace-variable-impact.js
src/layer-c-memory/query/queries/project-query.js
src/layer-c-memory/storage/repository/adapters/sqlite-query-operations.js
```

---

## ‚úÖ Testing

Verified with:
- `get_server_status` ‚Üí Now shows correct totalFiles: 1819, totalFunctions: 13042
- `trace_variable_impact` ‚Üí Loads file atoms + external relations correctly
- `get_health_metrics` ‚Üí Optimized to load only file atoms when filePath specified
- `suggest_refactoring` ‚Üí Optimized to load only file atoms when filePath specified
