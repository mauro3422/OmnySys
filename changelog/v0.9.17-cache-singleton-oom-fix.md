# v0.9.17 ‚Äî Cache Singleton: Fix Memory Leak / OOM en LLMAnalyzer

**Fecha:** 2026-02-18  
**Tipo:** `fix` + `refactor` ‚Äî Critical Bug Fix  
**Estado:** ‚úÖ Completo ‚Äî 284/284 tests pasando

---

## üî¥ Problema Ra√≠z (Issue #1 ‚Äî Memory Leak / OOM)

`UnifiedCacheManager.initialize()` era llamado **una vez por job LLM**. En proyectos grandes:

- **213 jobs LLM** √ó **2045 archivos** = **~435.000 operaciones de disco**
- Cada instancia cargaba todo `.omnysysdata/files/` en RAM ‚Üí **OOM crash inevitable**
- El proceso mor√≠a silenciosamente despu√©s de varios an√°lisis consecutivos

### Flujo anterior (roto):
```
LLMAnalyzer.analyze(file) ‚Üí new UnifiedCacheManager() ‚Üí initialize() ‚Üí loadFromLayerA()
                                                                          ‚Ü≥ lee 2045 archivos √ó 213 veces = OOM
```

### Flujo nuevo (corregido):
```
LLMAnalyzer.analyze(file) ‚Üí getCacheManager(projectPath) ‚Üí Map.get() ‚Üí instancia existente (O(1))
                                                              ‚Ü≥ primera vez: init() UNA SOLA VEZ
```

---

## ‚úÖ Cambios Implementados

### Nuevo archivo: `src/core/cache/singleton.js`

Singleton ESM por `projectPath` con deduplicaci√≥n de inicializaciones concurrentes:

- **`getCacheManager(projectPath, options?)`** ‚Äî Retorna siempre la misma instancia por path.  
  Si hay dos llamadas concurrentes antes de que termine el `initialize()`, comparten el mismo Promise (no hay double-init).
- **`invalidateCacheInstance(projectPath)`** ‚Äî Evicta del Map. Usado por `error-guardian` tras un `cache.clear()`.
- **`getCacheInstanceCount()`** / **`getCacheInstanceKeys()`** ‚Äî Helpers de diagn√≥stico/observabilidad.

### Archivos modificados (todos los sitios que creaban `new UnifiedCacheManager + initialize()`):

| Archivo | Cambio |
|---------|--------|
| `src/layer-b-semantic/llm-analyzer/core.js` | **Fix principal** ‚Äî `getCacheManager(this.projectPath)` |
| `src/layer-a-static/indexer.js` | `getCacheManager(absoluteRootPath)` |
| `src/layer-c-memory/mcp/core/initialization/steps/cache-init-step.js` | `getCacheManager(server.projectPath)` |
| `src/core/unified-server/initialization/cache-manager.js` | `getCacheManager(projectPath)` |
| `src/core/orchestrator/lifecycle/init/main.js` | `getCacheManager(this.projectPath)` (fallback path) |
| `src/core/error-guardian/handlers/recovery-handler/actions/cache-actions.js` | Agrega `invalidateCacheInstance(projectPath)` tras `clear()` |

### `src/core/cache/index.js` ‚Äî Re-exports + Fix de bug pre-existente

Se exportaba `analyzeWithLLMCache` que no exist√≠a ‚Üí ahora es alias de `analyzeLLMWithUnifiedCache`:

```javascript
export {
  analyzeWithUnifiedCache,
  analyzeLLMWithUnifiedCache,
  analyzeLLMWithUnifiedCache as analyzeWithLLMCache  // backward-compat alias
} from './integration.js';
export { getCacheManager, invalidateCacheInstance, getCacheInstanceCount, getCacheInstanceKeys } from './singleton.js';
```

---

## üß™ Tests Nuevos

### `tests/unit/core/cache/singleton.test.js` ‚Äî 27 tests

- Instanciaci√≥n correcta (loaded=true, interfaz completa)
- Identidad singleton (mismo path ‚Üí mismo `===` objeto)
- Paths diferentes ‚Üí instancias diferentes
- Concurrencia: 5 llamadas paralelas ‚Üí mismo Promise, `initialize()` llamado exactamente 1x
- `invalidateCacheInstance` ‚Üí nueva instancia en siguiente llamada
- Helpers de diagn√≥stico (`count`, `keys`)
- Re-exports desde `core/cache/index.js`

### `tests/factories/core-cache/builders.js` + `index.js`

- `CacheManagerConfigBuilder` ‚Äî configs por defecto y producci√≥n
- `MockCacheManagerBuilder` ‚Äî mock completo sin I/O, ideal para unit tests
- `CacheEntryBuilder` ‚Äî entradas de √≠ndice de cach√©

---

## üìä M√©tricas

| M√©trica | Antes | Despu√©s |
|---------|-------|---------|
| Llamadas a `loadFromLayerA()` por sesi√≥n | N √ó jobs | 1 (primera) |
| Operaciones de disco (213 jobs √ó 2045 archivos) | ~435K | ~2045 |
| Archivos de test | 283 | 284 |
| Tests totales | 4044 | 4071 |
| Tests pasando | 284/284 | 284/284 ‚úÖ |

---

## üîë Alias de Package

El singleton est√° disponible v√≠a alias existente:

```javascript
import { getCacheManager, invalidateCacheInstance } from '#core/cache/singleton.js';
// o bien desde el barrel:
import { getCacheManager } from '#core/cache/index.js';
```

---

## Impacto

- **Cr√≠tico** para proyectos con >100 archivos y an√°lisis LLM habilitado
- Sin esta correcci√≥n, el proceso crasheaba silenciosamente con OOM despu√©s de N an√°lisis consecutivos
- La correcci√≥n es **retrocompatible** ‚Äî la API p√∫blica de `UnifiedCacheManager` no cambia
