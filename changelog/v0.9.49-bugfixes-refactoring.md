# v0.9.49 - Bugfixes + Refactoring de God Functions

**Release Date**: 2026-02-21

## Resumen

Sesi√≥n de estabilizaci√≥n post-v0.9.48: correcci√≥n de bugs medianos detectados por `simulate_data_journey`, mejoras al generador de tests, conexi√≥n del reporte `fieldCoverage` en `get_atom_schema`, y refactoring de las principales god functions del sistema.

---

## üêõ Bugfixes

### 1. `extractSemanticDomain` ‚Äî crash con `code` null/undefined

**Archivo**: `src/layer-a-static/extractors/metadata/semantic-domain.js`

El extractor crasheaba si recib√≠a `null` o un valor no-string como `code`. Se agreg√≥ early return defensivo.

```js
if (!code || typeof code !== 'string') {
  return { primary: 'unknown', confidence: 0, allDomains: [], ... };
}
```

### 2. `extractAtomMetadata` ‚Äî casting defensivo de par√°metros

**Archivo**: `src/layer-a-static/extractors/metadata/index.js`

Se agrega casting de los 3 par√°metros antes de llamar a `extractSemanticDomain`, evitando propagaci√≥n de tipos incorrectos desde upstream.

### 3. `get_atom_schema` ‚Äî import `getAvailableFields` sin usar

**Archivo**: `src/layer-c-memory/mcp/tools/get-atom-schema.js`

`getAvailableFields` era importado pero nunca llamado. Ahora se usa para construir el bloque `fieldCoverage` en la respuesta:

```json
{
  "fieldCoverage": {
    "total": 42,
    "covered": 42,
    "orphaned": 0,
    "pct": "100%",
    "orphanedFields": []
  }
}
```

Resultado: **100% de campos del registry tienen al menos 1 tool que los consume**. Cualquier extractor nuevo sin `usedByTools` aparecer√° autom√°ticamente en `orphanedFields`.

---

## ‚ú® Mejoras al Generador de Tests

### `test-analyzer.js`
- `generateAssertion` ahora usa `typeContracts`, `dna.flowType` y `dataFlow.outputs` para assertions espec√≠ficos (array, number, string, boolean, object) en lugar de `toBeTruthy()` gen√©rico
- `createEdgeCaseTests` cubre **todos** los inputs (antes solo los primeros 2) + agrega caso string vac√≠o para params string
- Threshold de branch coverage: `complexity > 15` ‚Üí `complexity > 8` (m√°s cobertura)
- `createArchetypeTests` usa `callerPattern`, `calledBy` y `dna.flowType` para nombrar y estructurar mejor los tests; agregados casos para arquetipos `factory` y `persister`

### `code-generator.js`
- `generateInputCall` reemplaza el fallback `'{}'` con `inferFallbackValue(input)` que infiere valores por nombre de par√°metro (`path`, `url`, `id`, `text`, etc.)

### `batch-generator.js`
- Implementado `dryRun=false`: crea directorios y escribe archivos con `fs.mkdir` + `fs.writeFile`
- Nueva opci√≥n `sortBy: 'fragility'` (antes solo `risk` y `complexity`)
- Pre-enriquece gaps con `fragilityScore` y `testabilityScore` v√≠a `getAtomDetails`

### `index.js` (MCP tools)
- Descripci√≥n actualizada de `get_atom_schema` para mencionar `fieldCoverage`
- `generate_batch_tests` sortBy enum incluye `'fragility'`

---

## ‚ôªÔ∏è Refactoring de God Functions

### `call-graph-analyzer.js` ‚Äî `findCallSites` (complejidad 47)

Extracci√≥n de 3 helpers privados del loop principal:

| Helper | Responsabilidad |
|--------|----------------|
| `resolveImportInfo(depAnalysis, targetFile, symbolName)` | Resuelve alias local + namespace del import |
| `matchCallSite(line, localName, namespaceName)` | Detecta tipo de call site, retorna `{type, name, callType}` o null |
| `buildCallSiteEntry(...)` | Construye el objeto del call site |

### `analysis-decider.js` ‚Äî `computeMetadataCompleteness` (complejidad 43)

Dividida en 7 helpers enfocados:

| Helper | Responsabilidad |
|--------|----------------|
| `classifyFile(filePath, imports, usedBy)` | Flags del archivo (isEntryPoint, isTestFile, etc.) |
| `checkAtoms(totalAtoms, flags, gaps)` | Verifica que existan √°tomos |
| `checkUsedBy(usedBy, flags, gaps)` | Verifica dependientes |
| `checkDataFlow(atoms, flags, totalAtoms, gaps)` | Verifica flujo de datos |
| `checkCalls(atoms, totalAtoms, flags, gaps)` | Verifica llamadas |
| `checkImportsExports(imports, exports, flags, gaps)` | Verifica imports/exports |
| `checkSemanticConnections(fileAnalysis, gaps)` | Verifica conexiones sem√°nticas |

Eliminadas **3 funciones dead code** que no eran llamadas por nadie:
- `hasUnresolvedEvents`
- `hasUnresolvedSharedState`
- `hasLowConfidenceConnections`

### `trace-variable-impact.js` ‚Äî funci√≥n principal (complejidad 43)

Extra√≠dos 2 helpers del setup inicial:

| Helper | Responsabilidad |
|--------|----------------|
| `buildAtomIndices(allAtoms)` | Construye `Map` por id y por nombre |
| `findSourceAtom(allAtoms, filePath, symbolName)` | Localiza el √°tomo fuente |

### `caller-pattern.js` ‚Äî `detectCallerPattern` (complejidad 39, 305 l√≠neas)

Extra√≠dos 4 helpers de detecci√≥n de tipo de archivo, reduciendo el cuerpo de la funci√≥n:

| Helper | Responsabilidad |
|--------|----------------|
| `isTestFile(filePath)` | Detecta archivos de test |
| `isScriptOrInstallFile(filePath)` | Detecta scripts e instaladores |
| `isClassMethod(atom)` | Detecta m√©todos de clase |
| `isHandlerName(name)` | Detecta Handler/Controller/Route/Middleware |

---

## üìä M√©tricas

| Archivo | L√≠neas antes | L√≠neas despu√©s |
|---------|-------------|----------------|
| `analysis-decider.js` | 258 | 210 (-48) |
| `trace-variable-impact.js` | 249 | 238 (-11) |
| `caller-pattern.js` | 305 | 237 (-68) |

**Archivos no refactorizados** (ya estaban bien estructurados):
- `purpose.js` (200 l√≠neas, cadena lineal de returns)
- `metadata-builder.js` (204 l√≠neas, literal de objeto con 3 helpers ya extra√≠dos)

---

## ‚úÖ Validaciones

- `validate_imports` con `checkFileExistence: true` en todos los archivos modificados ‚Üí **0 imports rotos**
- Public API sin cambios en todos los archivos refactorizados
- `fieldCoverage` en `get_atom_schema` muestra **100% cobertura** (42/42 campos)

---

## Sin Breaking Changes

Todos los cambios son internos. Ninguna firma p√∫blica fue modificada.
