# v0.9.46 - MCP Tools Bug Fixes + Quality Improvements

**Fecha**: 2026-02-20

**Cambios**: CorrecciÃ³n de problemas menores en 4 herramientas MCP + nueva herramienta `find_symbol_instances` + auditorÃ­a completa del sistema. Mejoras de calidad y reducciÃ³n de ruido en los anÃ¡lisis.

---

## Fixed Tools

### 1. `get_async_analysis` - DeduplicaciÃ³n de optimizaciones

**Problema**: Las optimizaciones se agregaban duplicadas cuando un mismo Ã¡tomo tenÃ­a mÃºltiples oportunidades del mismo tipo.

**Fix**: Implementada deduplicaciÃ³n por clave compuesta `atom+type`:

```javascript
const optKey = `${opt.atom}:${opt.type}`;
const existingOpt = analysis.optimizations.find(o => `${o.atom}:${o.type}` === optKey);
if (!existingOpt) {
  analysis.optimizations.push(opt);
}
```

**Resultado**: 191 optimizaciones Ãºnicas (sin duplicados).

---

### 2. `explain_value_flow` - Dependencies con contexto

**Problema**: El array `dependencies` devolvÃ­a solo nombres de funciones sin contexto (ej: `toLowerCase`, `filter`), sin distinguir entre built-ins de JavaScript y funciones del proyecto.

**Fix**: Cada dependencia ahora incluye `type` y `context`:

```json
{
  "dependencies": [
    {
      "name": "toLowerCase",
      "type": "native",
      "context": "JavaScript built-in"
    },
    {
      "name": "persistido",
      "type": "unknown",
      "context": "Project or external"
    }
  ]
}
```

**Cobertura**: 100+ mÃ©todos nativos de JavaScript identificados (Array, String, Object, Promise, JSON, Math, console, etc.)

---

### 3. `validate_imports` - ExclusiÃ³n de paths por defecto

**Problema**: Reportaba falsos positivos en directorios legacy como `archive/` donde los imports estÃ¡n intencionalmente rotos (cÃ³digo de respaldo).

**Fix**: 
- Nuevo parÃ¡metro `excludePaths` (array)
- Exclusiones por defecto: `['archive/', 'node_modules/', '.git/', 'dist/', 'build/', 'coverage/']`
- Se pueden agregar paths adicionales via parÃ¡metro

**Resultado**: 
- Antes: 4 imports rotos reportados (todos en `archive/`)
- Ahora: 0 imports rotos en producciÃ³n âœ…

---

### 4. `trace_data_journey` - Mensajes explicativos

**Problema**: Cuando una variable no cruzaba boundaries de archivos, devolvÃ­a `steps: []` sin explicaciÃ³n, generando confusiÃ³n.

**Fix**: Campo `explanation` aÃ±adido al resultado:

```json
{
  "explanation": "Variable 'atomMetadata' is used locally in detectAtomArchetype but is not passed to any other functions across file boundaries. This is expected for local variables."
}
```

**Casos cubiertos**:
- Variable no encontrada en la funciÃ³n fuente
- Variable usada localmente pero no pasada a otras funciones

---

## Technical Debt Analysis

AuditorÃ­a del sistema usando las propias herramientas MCP:

### System Health Overview

```
Total Atoms:        7,462
Overall Score:      99/100 (Grade A)
Average Complexity: 3.0

Health Distribution:
- Grade A: 7,290 (97.7%)
- Grade B: 88 (1.2%)
- Grade C: 35 (0.5%)
- Grade D: 27 (0.4%)
- Grade F: 22 (0.3%) âš ï¸
```

### God Functions Detected (192 total)

Top 3 por complejidad:

| FunciÃ³n | Complejidad | LÃ­neas | Archivo |
|---------|-------------|--------|---------|
| `checkLogic` | 72 | 240 | `src/cli/commands/check.js` |
| `detectAtomArchetype` | 57 | 131 | `src/layer-a-static/.../archetype.js` |
| `main` (audit-real-quality) | 56 | 250 | `scripts/audit-real-quality.js` |

### Async Analysis Results

```
Async Atoms:        1,581
With Issues:        403
High Risk:          116
Medium Risk:        137
Low Risk:           1,328

Top Issues:
- _analyzeComplexFilesWithLLM: 18 awaits secuenciales
- restart_server: 14 awaits secuenciales
- indexProject: 10 awaits secuenciales

Parallelization Opportunities: 191 total
Max Potential Gain: ~91% time reduction (scripts/omny-tools.js::main)
```

### Race Conditions Detected

```
Total Races: 18
- Critical: 3 (read-write conflicts)
- High: 4 (write-write conflicts)
- Medium: 11 (init-error races)

Critical Resources:
- call:write (6 funciones concurrentes)
- call:set (20 funciones concurrentes)
- call:validateWrite (2 funciones)
```

### Unhealthy Atoms (Grade D/F)

**22 Ã¡tomos con grado F** (requieren refactorizaciÃ³n urgente):

```javascript
// Peores casos:
scripts/audit-real-quality.js::main
  - Complejidad: 56 (max: 15)
  - LÃ­neas: 250 (max: 50)
  - Llamadas: 27 (max: 10)

scripts/audit-data-integrity.js::main
  - Complejidad: 37
  - LÃ­neas: 208
  - Nested loops: true
```

**RecomendaciÃ³n**: Priorizar refactorizaciÃ³n de scripts en `scripts/` - son herramientas de anÃ¡lisis, no cÃ³digo de producciÃ³n.

---

## Files Changed

```
src/layer-c-memory/mcp/tools/get-async-analysis.js
src/layer-c-memory/mcp/tools/explain-value-flow.js
src/layer-c-memory/mcp/tools/lib/analysis/value-flow-analyzer.js
src/layer-c-memory/mcp/tools/trace-data-journey.js
src/layer-c-memory/mcp/tools/validate-imports.js
```

**Stats**: 5 archivos, +76/-5 lÃ­neas

---

## Migration Guide

No requiere migraciÃ³n. Los cambios son:
- âœ… Backward compatible (nuevos campos opcionales)
- âœ… No breaking changes en APIs existentes
- âœ… Mejoras de calidad de datos

---

## Analysis Scripts Separation (New Feature)

### Problema
Scripts de anÃ¡lisis en `scripts/` (audit-*, analyze-*, validate-*, etc.) aparecÃ­an mezclados con cÃ³digo de producciÃ³n en reportes de deuda tÃ©cnica, generando ruido y distracciÃ³n.

### SoluciÃ³n
- Nuevo propÃ³sito `ANALYSIS_SCRIPT` para herramientas de auditorÃ­a
- `get_health_metrics` separa en dos secciones:
  - `unhealthyAtoms`: CÃ³digo de producciÃ³n (alta prioridad)
  - `internalTools`: Scripts de anÃ¡lisis (baja prioridad, con nota)
- `detect_patterns` excluye scripts de god-functions por defecto

### Resultado
```
Before: 192 god-functions (mezclados con scripts de anÃ¡lisis)
After:  174 god-functions (18 scripts excluidos automÃ¡ticamente)
```

### Cambios en archivos
- `src/shared/derivation-engine/rules/purpose-rules.js` - Nuevo propÃ³sito ANALYSIS_SCRIPT
- `src/layer-c-memory/mcp/tools/get-health-metrics.js` - SeparaciÃ³n de internalTools
- `src/layer-c-memory/mcp/tools/detect-patterns.js` - ExclusiÃ³n de scripts de anÃ¡lisis
- `src/layer-a-static/pipeline/phases/atom-extraction/metadata/purpose.js` - Reglas de detecciÃ³n actualizadas

---

## New Tool: `find_symbol_instances`

### Problema que resuelve
Me confundÃ­ editando el archivo equivocado (`purpose-rules.js` en lugar de `metadata/purpose.js`). Esto pasa porque:
- Hay funciones con el mismo nombre en diferentes archivos
- No queda claro cuÃ¡l es la implementaciÃ³n "real" vs copias sin usar
- No hay forma rÃ¡pida de ver todas las instancias de un sÃ­mbolo

### SoluciÃ³n
Nueva herramienta MCP que encuentra todas las instancias de un sÃ­mbolo:

```javascript
// Uso
find_symbol_instances({ symbolName: "detectAtomPurpose" })

// Resultado
{
  symbol: "detectAtomPurpose",
  summary: {
    totalInstances: 2,
    primaryInstance: {
      file: "src/layer-a-static/.../purpose.js",
      line: 32
    },
    duplicateGroups: 0,
    unusedInstances: 1
  },
  instances: [
    {
      file: "src/layer-a-static/.../purpose.js",
      line: 32,
      usage: { importedBy: 1, calledBy: 15, total: 16 },
      status: "âœ… PRIMARY",
      isPrimary: true
    },
    {
      file: "src/shared/.../purpose-rules.js",
      line: 85,
      usage: { importedBy: 0, calledBy: 0, total: 0 },
      status: "âš ï¸ UNUSED",
      isUnused: true
    }
  ],
  recommendations: [
    {
      type: "success",
      message: "Instancia primaria identificada: src/layer-a-static/.../purpose.js",
      action: "edit_this_file"
    },
    {
      type: "warning",
      message: "1 instancia(s) no se usa(n) en el proyecto. PodrÃ­an eliminarse.",
      files: ["src/shared/.../purpose-rules.js"],
      action: "consider_removal"
    }
  ]
}
```

### CaracterÃ­sticas
- âœ… Encuentra todas las funciones/variables con el mismo nombre
- âœ… Detecta duplicados exactos (usando structuralHash)
- âœ… Identifica la instancia primaria (la mÃ¡s usada)
- âœ… Muestra quiÃ©n importa y quiÃ©n llama a cada instancia
- âš ï¸ Advierte sobre implementaciones sin usar
- ğŸ¯ Recomienda cuÃ¡l archivo editar
- ğŸ” **MODO AUTO-DETECCIÃ“N**: Escanea TODO el proyecto sin necesidad de especificar nombre

### Modo Auto-Detect (Nuevo)

```javascript
// Escanea automÃ¡ticamente todos los duplicados
find_symbol_instances({ autoDetect: true })

// Resultado:
{
  mode: 'auto_detect',
  summary: {
    totalDuplicatesFound: 18,
    criticalDuplicates: 2,  // >2 copias
    totalInstances: 47,
    potentialSavingsLOC: 688
  },
  topPriority: [
    {
      symbol: 'validate',
      action: 'Consolidar 4 copias en scripts/validate-graph-system.js',
      savings: '12 LOC'
    }
  ]
}
```

**Score de Riesgo**: Calculado como `(uso Ã— 2) + (complejidad Ã— 3) + (lÃ­neas/10)`

### Files
- `src/layer-c-memory/mcp/tools/find-symbol-instances.js` - ImplementaciÃ³n
- `src/layer-c-memory/mcp/tools/index.js` - Registro en MCP

### Hallazgos Iniciales

Ejecutando auto-detecciÃ³n en OmnySystem:

```
âš ï¸ 18 grupos de duplicados encontrados
ğŸ”´ 2 duplicados CRÃTICOS (>2 copias):
   - "validate": 4 copias idÃ©nticas
   - "main": 3 copias idÃ©nticas

ğŸ’° Ahorro potencial: 688 lÃ­neas de cÃ³digo
ğŸ“ Prioridad: Consolidar en versiÃ³n canÃ³nica (mÃ¡s usada, en src/)
```

Esta herramienta ahora permite atacar la deuda tÃ©cnica **proactivamente** sin esperar a encontrar problemas por accidente.

---

## Testing

Todas las herramientas verificadas con servidor MCP:

```bash
âœ… get_async_analysis(limit: 5, riskLevel: "high")
âœ… explain_value_flow(detectAtomArchetype)
âœ… validate_imports(checkBroken: true)
âœ… trace_data_journey(atomMetadata)
âœ… analyze_signature_change(...)
âœ… get_health_metrics()
âœ… detect_patterns(god-functions)
âœ… get_call_graph(...)
âœ… find_symbol_instances(symbolName: "detectAtomPurpose")
```

**Resultado**: 100% de herramientas funcionando correctamente.
