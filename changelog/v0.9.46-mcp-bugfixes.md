# v0.9.46 - MCP Tools Bug Fixes + Quality Improvements

**Fecha**: 2026-02-20

**Cambios**: Correcci√≥n de problemas menores en 4 herramientas MCP + nueva herramienta `find_symbol_instances` + auditor√≠a completa del sistema. Mejoras de calidad y reducci√≥n de ruido en los an√°lisis.

---

## Fixed Tools

### 1. `get_async_analysis` - Deduplicaci√≥n de optimizaciones

**Problema**: Las optimizaciones se agregaban duplicadas cuando un mismo √°tomo ten√≠a m√∫ltiples oportunidades del mismo tipo.

**Fix**: Implementada deduplicaci√≥n por clave compuesta `atom+type`:

```javascript
const optKey = `${opt.atom}:${opt.type}`;
const existingOpt = analysis.optimizations.find(o => `${o.atom}:${o.type}` === optKey);
if (!existingOpt) {
  analysis.optimizations.push(opt);
}
```

**Resultado**: 191 optimizaciones √∫nicas (sin duplicados).

---

### 2. `explain_value_flow` - Dependencies con contexto

**Problema**: El array `dependencies` devolv√≠a solo nombres de funciones sin contexto (ej: `toLowerCase`, `filter`), sin distinguir entre built-ins de JavaScript y funciones del proyecto.

**Fix**: Cada dependencia ahora incluye `type` y `context`:

```json
{
  "dependencies": [
    {
      "name": "toLowerCase",
      "type": "native",
      "context": "JavaScript built-in"
    },
    {
      "name": "persistido",
      "type": "unknown",
      "context": "Project or external"
    }
  ]
}
```

**Cobertura**: 100+ m√©todos nativos de JavaScript identificados (Array, String, Object, Promise, JSON, Math, console, etc.)

---

### 3. `validate_imports` - Exclusi√≥n de paths por defecto

**Problema**: Reportaba falsos positivos en directorios legacy como `archive/` donde los imports est√°n intencionalmente rotos (c√≥digo de respaldo).

**Fix**: 
- Nuevo par√°metro `excludePaths` (array)
- Exclusiones por defecto: `['archive/', 'node_modules/', '.git/', 'dist/', 'build/', 'coverage/']`
- Se pueden agregar paths adicionales via par√°metro

**Resultado**: 
- Antes: 4 imports rotos reportados (todos en `archive/`)
- Ahora: 0 imports rotos en producci√≥n ‚úÖ

---

### 4. `trace_data_journey` - Mensajes explicativos

**Problema**: Cuando una variable no cruzaba boundaries de archivos, devolv√≠a `steps: []` sin explicaci√≥n, generando confusi√≥n.

**Fix**: Campo `explanation` a√±adido al resultado:

```json
{
  "explanation": "Variable 'atomMetadata' is used locally in detectAtomArchetype but is not passed to any other functions across file boundaries. This is expected for local variables."
}
```

**Casos cubiertos**:
- Variable no encontrada en la funci√≥n fuente
- Variable usada localmente pero no pasada a otras funciones

---

## Technical Debt Analysis

Auditor√≠a del sistema usando las propias herramientas MCP:

### System Health Overview

```
Total Atoms:        7,462
Overall Score:      99/100 (Grade A)
Average Complexity: 3.0

Health Distribution:
- Grade A: 7,290 (97.7%)
- Grade B: 88 (1.2%)
- Grade C: 35 (0.5%)
- Grade D: 27 (0.4%)
- Grade F: 22 (0.3%) ‚ö†Ô∏è
```

### God Functions Detected (192 total)

Top 3 por complejidad:

| Funci√≥n | Complejidad | L√≠neas | Archivo |
|---------|-------------|--------|---------|
| `checkLogic` | 72 | 240 | `src/cli/commands/check.js` |
| `detectAtomArchetype` | 57 | 131 | `src/layer-a-static/.../archetype.js` |
| `main` (audit-real-quality) | 56 | 250 | `scripts/audit-real-quality.js` |

### Async Analysis Results

```
Async Atoms:        1,581
With Issues:        403
High Risk:          116
Medium Risk:        137
Low Risk:           1,328

Top Issues:
- _analyzeComplexFilesWithLLM: 18 awaits secuenciales
- restart_server: 14 awaits secuenciales
- indexProject: 10 awaits secuenciales

Parallelization Opportunities: 191 total
Max Potential Gain: ~91% time reduction (scripts/omny-tools.js::main)
```

### Race Conditions Detected

```
Total Races: 18
- Critical: 3 (read-write conflicts)
- High: 4 (write-write conflicts)
- Medium: 11 (init-error races)

Critical Resources:
- call:write (6 funciones concurrentes)
- call:set (20 funciones concurrentes)
- call:validateWrite (2 funciones)
```

### Unhealthy Atoms (Grade D/F)

**22 √°tomos con grado F** (requieren refactorizaci√≥n urgente):

```javascript
// Peores casos:
scripts/audit-real-quality.js::main
  - Complejidad: 56 (max: 15)
  - L√≠neas: 250 (max: 50)
  - Llamadas: 27 (max: 10)

scripts/audit-data-integrity.js::main
  - Complejidad: 37
  - L√≠neas: 208
  - Nested loops: true
```

**Recomendaci√≥n**: Priorizar refactorizaci√≥n de scripts en `scripts/` - son herramientas de an√°lisis, no c√≥digo de producci√≥n.

---

## Files Changed

```
src/layer-c-memory/mcp/tools/get-async-analysis.js
src/layer-c-memory/mcp/tools/explain-value-flow.js
src/layer-c-memory/mcp/tools/lib/analysis/value-flow-analyzer.js
src/layer-c-memory/mcp/tools/trace-data-journey.js
src/layer-c-memory/mcp/tools/validate-imports.js
```

**Stats**: 5 archivos, +76/-5 l√≠neas

---

## Migration Guide

No requiere migraci√≥n. Los cambios son:
- ‚úÖ Backward compatible (nuevos campos opcionales)
- ‚úÖ No breaking changes en APIs existentes
- ‚úÖ Mejoras de calidad de datos

---

## Analysis Scripts Separation (New Feature)

### Problema
Scripts de an√°lisis en `scripts/` (audit-*, analyze-*, validate-*, etc.) aparec√≠an mezclados con c√≥digo de producci√≥n en reportes de deuda t√©cnica, generando ruido y distracci√≥n.

### Soluci√≥n
- Nuevo prop√≥sito `ANALYSIS_SCRIPT` para herramientas de auditor√≠a
- `get_health_metrics` separa en dos secciones:
  - `unhealthyAtoms`: C√≥digo de producci√≥n (alta prioridad)
  - `internalTools`: Scripts de an√°lisis (baja prioridad, con nota)
- `detect_patterns` excluye scripts de god-functions por defecto

### Resultado
```
Before: 192 god-functions (mezclados con scripts de an√°lisis)
After:  174 god-functions (18 scripts excluidos autom√°ticamente)
```

### Cambios en archivos
- `src/shared/derivation-engine/rules/purpose-rules.js` - Nuevo prop√≥sito ANALYSIS_SCRIPT
- `src/layer-c-memory/mcp/tools/get-health-metrics.js` - Separaci√≥n de internalTools
- `src/layer-c-memory/mcp/tools/detect-patterns.js` - Exclusi√≥n de scripts de an√°lisis
- `src/layer-a-static/pipeline/phases/atom-extraction/metadata/purpose.js` - Reglas de detecci√≥n actualizadas

---

## New Tool: `find_symbol_instances`

### Problema que resuelve
Me confund√≠ editando el archivo equivocado (`purpose-rules.js` en lugar de `metadata/purpose.js`). Esto pasa porque:
- Hay funciones con el mismo nombre en diferentes archivos
- No queda claro cu√°l es la implementaci√≥n "real" vs copias sin usar
- No hay forma r√°pida de ver todas las instancias de un s√≠mbolo

### Soluci√≥n
Nueva herramienta MCP que encuentra todas las instancias de un s√≠mbolo:

```javascript
// Uso
find_symbol_instances({ symbolName: "detectAtomPurpose" })

// Resultado
{
  symbol: "detectAtomPurpose",
  summary: {
    totalInstances: 2,
    primaryInstance: {
      file: "src/layer-a-static/.../purpose.js",
      line: 32
    },
    duplicateGroups: 0,
    unusedInstances: 1
  },
  instances: [
    {
      file: "src/layer-a-static/.../purpose.js",
      line: 32,
      usage: { importedBy: 1, calledBy: 15, total: 16 },
      status: "‚úÖ PRIMARY",
      isPrimary: true
    },
    {
      file: "src/shared/.../purpose-rules.js",
      line: 85,
      usage: { importedBy: 0, calledBy: 0, total: 0 },
      status: "‚ö†Ô∏è UNUSED",
      isUnused: true
    }
  ],
  recommendations: [
    {
      type: "success",
      message: "Instancia primaria identificada: src/layer-a-static/.../purpose.js",
      action: "edit_this_file"
    },
    {
      type: "warning",
      message: "1 instancia(s) no se usa(n) en el proyecto. Podr√≠an eliminarse.",
      files: ["src/shared/.../purpose-rules.js"],
      action: "consider_removal"
    }
  ]
}
```

### Caracter√≠sticas
- ‚úÖ Encuentra todas las funciones/variables con el mismo nombre
- ‚úÖ Detecta duplicados exactos (usando structuralHash)
- ‚úÖ Identifica la instancia primaria (la m√°s usada)
- ‚úÖ Muestra qui√©n importa y qui√©n llama a cada instancia
- ‚ö†Ô∏è Advierte sobre implementaciones sin usar
- üéØ Recomienda cu√°l archivo editar

### Files
- `src/layer-c-memory/mcp/tools/find-symbol-instances.js` - Implementaci√≥n
- `src/layer-c-memory/mcp/tools/index.js` - Registro en MCP

---

## Testing

Todas las herramientas verificadas con servidor MCP:

```bash
‚úÖ get_async_analysis(limit: 5, riskLevel: "high")
‚úÖ explain_value_flow(detectAtomArchetype)
‚úÖ validate_imports(checkBroken: true)
‚úÖ trace_data_journey(atomMetadata)
‚úÖ analyze_signature_change(...)
‚úÖ get_health_metrics()
‚úÖ detect_patterns(god-functions)
‚úÖ get_call_graph(...)
‚úÖ find_symbol_instances(symbolName: "detectAtomPurpose")
```

**Resultado**: 100% de herramientas funcionando correctamente.
