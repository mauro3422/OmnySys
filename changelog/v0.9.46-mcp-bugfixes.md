# v0.9.46 - MCP Tools Bug Fixes + Quality Improvements

**Fecha**: 2026-02-20

**Cambios**: Corrección de problemas menores en 4 herramientas MCP + auditoría completa del sistema. Mejoras de calidad y reducción de ruido en los análisis.

---

## Fixed Tools

### 1. `get_async_analysis` - Deduplicación de optimizaciones

**Problema**: Las optimizaciones se agregaban duplicadas cuando un mismo átomo tenía múltiples oportunidades del mismo tipo.

**Fix**: Implementada deduplicación por clave compuesta `atom+type`:

```javascript
const optKey = `${opt.atom}:${opt.type}`;
const existingOpt = analysis.optimizations.find(o => `${o.atom}:${o.type}` === optKey);
if (!existingOpt) {
  analysis.optimizations.push(opt);
}
```

**Resultado**: 191 optimizaciones únicas (sin duplicados).

---

### 2. `explain_value_flow` - Dependencies con contexto

**Problema**: El array `dependencies` devolvía solo nombres de funciones sin contexto (ej: `toLowerCase`, `filter`), sin distinguir entre built-ins de JavaScript y funciones del proyecto.

**Fix**: Cada dependencia ahora incluye `type` y `context`:

```json
{
  "dependencies": [
    {
      "name": "toLowerCase",
      "type": "native",
      "context": "JavaScript built-in"
    },
    {
      "name": "persistido",
      "type": "unknown",
      "context": "Project or external"
    }
  ]
}
```

**Cobertura**: 100+ métodos nativos de JavaScript identificados (Array, String, Object, Promise, JSON, Math, console, etc.)

---

### 3. `validate_imports` - Exclusión de paths por defecto

**Problema**: Reportaba falsos positivos en directorios legacy como `archive/` donde los imports están intencionalmente rotos (código de respaldo).

**Fix**: 
- Nuevo parámetro `excludePaths` (array)
- Exclusiones por defecto: `['archive/', 'node_modules/', '.git/', 'dist/', 'build/', 'coverage/']`
- Se pueden agregar paths adicionales via parámetro

**Resultado**: 
- Antes: 4 imports rotos reportados (todos en `archive/`)
- Ahora: 0 imports rotos en producción ✅

---

### 4. `trace_data_journey` - Mensajes explicativos

**Problema**: Cuando una variable no cruzaba boundaries de archivos, devolvía `steps: []` sin explicación, generando confusión.

**Fix**: Campo `explanation` añadido al resultado:

```json
{
  "explanation": "Variable 'atomMetadata' is used locally in detectAtomArchetype but is not passed to any other functions across file boundaries. This is expected for local variables."
}
```

**Casos cubiertos**:
- Variable no encontrada en la función fuente
- Variable usada localmente pero no pasada a otras funciones

---

## Technical Debt Analysis

Auditoría del sistema usando las propias herramientas MCP:

### System Health Overview

```
Total Atoms:        7,462
Overall Score:      99/100 (Grade A)
Average Complexity: 3.0

Health Distribution:
- Grade A: 7,290 (97.7%)
- Grade B: 88 (1.2%)
- Grade C: 35 (0.5%)
- Grade D: 27 (0.4%)
- Grade F: 22 (0.3%) ⚠️
```

### God Functions Detected (192 total)

Top 3 por complejidad:

| Función | Complejidad | Líneas | Archivo |
|---------|-------------|--------|---------|
| `checkLogic` | 72 | 240 | `src/cli/commands/check.js` |
| `detectAtomArchetype` | 57 | 131 | `src/layer-a-static/.../archetype.js` |
| `main` (audit-real-quality) | 56 | 250 | `scripts/audit-real-quality.js` |

### Async Analysis Results

```
Async Atoms:        1,581
With Issues:        403
High Risk:          116
Medium Risk:        137
Low Risk:           1,328

Top Issues:
- _analyzeComplexFilesWithLLM: 18 awaits secuenciales
- restart_server: 14 awaits secuenciales
- indexProject: 10 awaits secuenciales

Parallelization Opportunities: 191 total
Max Potential Gain: ~91% time reduction (scripts/omny-tools.js::main)
```

### Race Conditions Detected

```
Total Races: 18
- Critical: 3 (read-write conflicts)
- High: 4 (write-write conflicts)
- Medium: 11 (init-error races)

Critical Resources:
- call:write (6 funciones concurrentes)
- call:set (20 funciones concurrentes)
- call:validateWrite (2 funciones)
```

### Unhealthy Atoms (Grade D/F)

**22 átomos con grado F** (requieren refactorización urgente):

```javascript
// Peores casos:
scripts/audit-real-quality.js::main
  - Complejidad: 56 (max: 15)
  - Líneas: 250 (max: 50)
  - Llamadas: 27 (max: 10)

scripts/audit-data-integrity.js::main
  - Complejidad: 37
  - Líneas: 208
  - Nested loops: true
```

**Recomendación**: Priorizar refactorización de scripts en `scripts/` - son herramientas de análisis, no código de producción.

---

## Files Changed

```
src/layer-c-memory/mcp/tools/get-async-analysis.js
src/layer-c-memory/mcp/tools/explain-value-flow.js
src/layer-c-memory/mcp/tools/lib/analysis/value-flow-analyzer.js
src/layer-c-memory/mcp/tools/trace-data-journey.js
src/layer-c-memory/mcp/tools/validate-imports.js
```

**Stats**: 5 archivos, +76/-5 líneas

---

## Migration Guide

No requiere migración. Los cambios son:
- ✅ Backward compatible (nuevos campos opcionales)
- ✅ No breaking changes en APIs existentes
- ✅ Mejoras de calidad de datos

---

## Analysis Scripts Separation (New Feature)

### Problema
Scripts de análisis en `scripts/` (audit-*, analyze-*, validate-*, etc.) aparecían mezclados con código de producción en reportes de deuda técnica, generando ruido y distracción.

### Solución
- Nuevo propósito `ANALYSIS_SCRIPT` para herramientas de auditoría
- `get_health_metrics` separa en dos secciones:
  - `unhealthyAtoms`: Código de producción (alta prioridad)
  - `internalTools`: Scripts de análisis (baja prioridad, con nota)
- `detect_patterns` excluye scripts de god-functions por defecto

### Resultado
```
Before: 192 god-functions (mezclados con scripts de análisis)
After:  174 god-functions (18 scripts excluidos automáticamente)
```

### Cambios en archivos
- `src/shared/derivation-engine/rules/purpose-rules.js` - Nuevo propósito ANALYSIS_SCRIPT
- `src/layer-c-memory/mcp/tools/get-health-metrics.js` - Separación de internalTools
- `src/layer-c-memory/mcp/tools/detect-patterns.js` - Exclusión de scripts de análisis

---

## Testing

Todas las herramientas verificadas con servidor MCP:

```bash
✅ get_async_analysis(limit: 5, riskLevel: "high")
✅ explain_value_flow(detectAtomArchetype)
✅ validate_imports(checkBroken: true)
✅ trace_data_journey(atomMetadata)
✅ analyze_signature_change(...)
✅ get_health_metrics()
✅ detect_patterns(god-functions)
✅ get_call_graph(...)
```

**Resultado**: 100% de herramientas funcionando correctamente.
