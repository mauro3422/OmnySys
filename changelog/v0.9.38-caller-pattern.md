# v0.9.38 - Caller Pattern Detection + calledBy Enhancement + 3 New Tools

**Release Date**: 2026-02-20

---

## Summary

Nuevo sistema `callerPattern` que explica **POR QU√â** un √°tomo no tiene `calledBy`. Coverage "real" sube de ~45% a **99.9%**. + 3 nuevas herramientas MCP.

---

## New Features

### 1. Caller Pattern Detection

Nuevo campo `callerPattern` en cada √°tomo:

```json
{
  "callerPattern": {
    "id": "class_instance",
    "label": "Instancia de Clase",
    "icon": "üì¶",
    "reason": "Method of class LLMClient",
    "hasCallers": false,
    "confidence": 0.95
  }
}
```

**12 patrones detectados:**

| Patr√≥n | Descripci√≥n |
|--------|-------------|
| `direct_call` | Llamado directamente en el c√≥digo |
| `class_instance` | M√©todo llamado via instancia |
| `entry_point` | Entry point (main, handler) |
| `re_export` | Re-exportado de otro m√≥dulo |
| `test_framework` | Llamado por framework de testing |
| `truly_dead` | Realmente no usado |
| `cli_command` | Comando CLI registrado |
| `event_callback` | Event listener/callback |
| `archived` | C√≥digo archivado |
| `script_constant` | Constante interna de script |
| `internal_constant` | Constante interna no exportada |
| `dynamic_import` | Cargado via import() din√°mico |

### 2. Variable Reference Linkage

Nuevo paso en el indexer que detecta referencias a variables/constants exportadas:

- **+384 calledBy links** agregados para variables
- Coverage subi√≥ de 41.5% ‚Üí 44.8%

### 3. Three New MCP Tools

| Herramienta | Descripci√≥n |
|-------------|-------------|
| `get_atom_society` | Detecta cadenas (A‚ÜíB‚ÜíC), clusters, hubs y orphans |
| `detect_patterns` | Encuentra god functions, c√≥digo duplicado, fragile network |
| `get_health_metrics` | Calcula entrop√≠a, cohesi√≥n, distribuci√≥n de salud |

### 4. Enhanced `get_function_details`

Ahora retorna metadata adicional:
- `purpose` - API_EXPORT, CLASS_METHOD, etc.
- `callerPattern` - Patr√≥n de llamada
- `dna` - Hash estructural
- `performance` - bigO, nestedLoops
- `errorFlow` - catches, throws
- `temporal` - asyncPatterns, timers
- `typeContracts` - params, returns
- `dataFlow` - inputs, outputs, transformations

---

## Bug Fixes

| Issue | Fix | File |
|-------|-----|------|
| `search_files` error `map is not a function` | Agregado `Array.isArray()` check | `search.js:32` |
| `get_call_graph` no detecta referencias a variables | Nuevo patr√≥n `variable_reference` | `call-graph-analyzer.js:119` |

---

## Metrics

| M√©trica | Antes | Despu√©s |
|---------|-------|---------|
| Coverage nominal | 41.5% | **44.8%** |
| **Coverage "real"** | N/A | **99.9%** |
| Gaps explicados | 0 | **3,260** |
| Gaps no explicados | 3,284 | **0** |
| MCP Tools | 14 | **17** |

---

## Health Metrics (from get_health_metrics)

```
Overall Score: 99/100 (Grade A)
Health Distribution:
  - Grade A: 5,839 atoms (98.4%)
  - Grade B: 52 atoms
  - Grade C: 21 atoms
  - Grade D: 17 atoms
  - Grade F: 7 atoms (need attention)

Top God Functions:
  - indexProject: complexity 118, 420 LOC
  - checkLogic: complexity 72, 240 LOC
  - analyzeSingleFile: complexity 50, 175 LOC
```

---

## New Files

- `src/layer-a-static/pipeline/phases/atom-extraction/metadata/caller-pattern.js`
- `src/layer-c-memory/mcp/tools/get-atom-society.js`
- `src/layer-c-memory/mcp/tools/detect-patterns.js`
- `src/layer-c-memory/mcp/tools/get-health-metrics.js`
- `scripts/analyze-calledby-gaps.js`

## Modified Files

- `src/layer-a-static/indexer.js`
- `src/layer-c-memory/mcp/tools/index.js` - Ahora 17 herramientas
- `src/layer-c-memory/mcp/tools/get-function-details.js`
- `src/layer-c-memory/mcp/tools/search.js`
- `src/layer-c-memory/mcp/tools/lib/analysis/call-graph-analyzer.js`
