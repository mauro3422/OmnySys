# CHANGELOG - OmnySys v0.4.2

## [0.4.2] - 2026-02-03

### ðŸŽ¯ RESUMEN EJECUTIVO

VersiÃ³n enfocada en **optimizaciÃ³n de contexto LLM** y **preparaciÃ³n para anÃ¡lisis por funciÃ³n**.

- âœ… Contexto LLM optimizado: solo relevante, sin ruido
- âœ… Todos los imports con metadatos (no limitado a 3)
- âœ… OpciÃ³n C: AnÃ¡lisis por funciÃ³n implementado (futuro)
- âœ… Cache movido a `.OmnySystemData/`
- âœ… Servidor LLM configurado para 8GB VRAM real

---

## ðŸ§  CAMBIOS EN CAPA B - SEMANTIC ENRICHMENT

### 1. RefactorizaciÃ³n Semantic-Enricher

**Antes:** Monolito de 820+ lÃ­neas  
**DespuÃ©s:** MÃ³dulos separados en `enricher/`

```
src/layer-b-semantic/enricher/
â”œâ”€â”€ index.js              # API pÃºblica
â”œâ”€â”€ core.js               # FunciÃ³n principal enrichSemanticAnalysis()
â”œâ”€â”€ context-builders.js   # ConstrucciÃ³n de contexto (buildFileSpecificContext)
â”œâ”€â”€ mergers.js            # Merge de anÃ¡lisis (mergeAnalyses, mergeSharedState, mergeEvents)
â””â”€â”€ utils.js              # Utilidades (limitContextSize, getEnrichmentStats)
```

**LÃ­neas por archivo:**
- `core.js`: ~350 lÃ­neas
- `context-builders.js`: ~280 lÃ­neas  
- `mergers.js`: ~100 lÃ­neas
- `utils.js`: ~70 lÃ­neas
- `semantic-enricher.js`: 30 lÃ­neas (re-exports)

### 2. OptimizaciÃ³n de Contexto LLM

#### REGLA CRÃTICA DE ORO documentada en 4 archivos:

```javascript
// =============================================================================
// REGLA CRITICA DE ORO: SOLO PASAR CONTEXTO RELEVANTE AL LLM
// =============================================================================
// NUNCA pasar todo el system-map o archivos sin conexion al LLM.
// El LLM tiene contexto LIMITADO (15K tokens por slot con 8GB VRAM).
// Contexto irrelevante = ruido = alucinaciones = tokens desperdiciados.
// =============================================================================
```

#### QuÃ© se incluye en el prompt (actualizado):

| Contexto | Antes | DespuÃ©s |
|----------|-------|---------|
| **Imports** | Solo 3 primeros | **TODOS** con metadatos |
| **Metadatos de imports** | No | Exports, localStorage, eventos |
| **Shared state** | Todos los detectados | Todos (ya filtrados por capa A) |
| **Eventos** | Todos los detectados | Todos (ya filtrados por capa A) |
| **CÃ³digo** | 50KB (~12,500 tokens) | 15KB (~3,750 tokens) |
| **Static analysis** | JSON completo | Formato compacto |
| **Metadata vacÃ­a** | Incluida | **Filtrada** |

#### Ejemplo de prompt actualizado:

```
FILE: src/services/AuthService.js

POTENTIAL CONNECTIONS:
### Files with SHARED localStorage:
- src/stores/UserStore.js: Both files use localStorage key 'auth_token'
  Key: auth_token

### Direct Imports (with metadata):
- src/utils/api.js
  Exports: fetchUser, updateUser, deleteUser
  localStorage: [auth_token, user_prefs]
  Emits: [user:updated]
  
- src/config/constants.js
  Exports: API_URL, TIMEOUT
  
- src/helpers/auth.js
  Exports: isAuthenticated, getToken
  Listens: [auth:logout]

STATIC DATA: writes:[auth_token]|reads:[]|listeners:[]|emitters:[]

METADATA: No significant metadata

CODE:
```javascript
export function login(username, password) {
    const fakeToken = "jwt_token_12345";
    localStorage.setItem('auth_token', fakeToken);
}
```
```

### 3. Nuevo Extractor: Function Analyzer (OpciÃ³n C)

Archivo: `src/layer-b-semantic/function-analyzer.js` (9,100 bytes)

**PropÃ³sito:** AnÃ¡lisis granular por funciÃ³n (preparaciÃ³n para futuro)

**Capacidades:**
- `analyzeFunctions()` - Analiza archivo completo funciÃ³n por funciÃ³n
- `buildFunctionContext()` - Contexto especÃ­fico de una funciÃ³n
- `hasSideEffects()` - Detecta si funciÃ³n tiene side effects
- `isPureFunction()` - Detecta si funciÃ³n es pura

**QuÃ© detecta por funciÃ³n:**
- Solo imports que USA (no todos los del archivo)
- Variables globales que TOCA
- localStorage keys que lee/escribe
- Eventos que emite/escucha
- Llamadas a otras funciones
- JSDoc especÃ­fico de la funciÃ³n
- Si es async/await

**Por quÃ© es mejor que anÃ¡lisis por archivo:**
- Granularidad fina: solo ve lo que la funciÃ³n realmente usa
- Sin ruido de funciones no relacionadas en el mismo archivo
- Permite detectar dependencias circulares a nivel de funciÃ³n
- Mejor para archivos grandes (God Objects)

**Estado:** Implementado pero no activo (prÃ³ximo sprint)

---

## ðŸ¤– VALIDACIÃ“N DE RESPUESTAS LLM (ROBUSTEZ)

### Nuevo: llm-response-validator.js

Archivo: `src/layer-b-semantic/llm-response-validator.js` (8,555 bytes)

**Problema:** El LLM (LFM2-Extract 1.2B) a veces devuelve:
- MÃ©todos como keys: `setItem`, `getItem` âŒ
- Placeholders genÃ©ricos: `key1`, `key2`, `path/to/file.js` âŒ
- CÃ³digo JavaScript como eventos: `addEventListener`, `dispatchEvent` âŒ

**SoluciÃ³n implementada:**

| ValidaciÃ³n | DescripciÃ³n |
|------------|-------------|
| **localStorage keys** | Rechaza mÃ©todos (setItem, getItem, removeItem, clear) |
| **Event names** | Rechaza mÃ©todos DOM (addEventListener, click, submit) |
| **File paths** | Rechaza placeholders y cÃ³digo como paths |
| **Placeholders** | Detecta y rechaza `key1`, `key2`, `event1`, `event2` |

**API pÃºblica:**
```javascript
validateLLMResponse(response, code, validFilePaths)
// Retorna respuesta sanitizada o null si es invÃ¡lida

extractActualLocalStorageKeys(code)
// Extrae keys reales del cÃ³digo fuente

extractActualEventNames(code)
// Extrae eventos reales del cÃ³digo fuente

calculateDynamicTimeout(code)
// Calcula timeout basado en tamaÃ±o: 10s + 1s por cada 1000 chars
```

### Retry con Backoff

```javascript
Intento 1 â†’ Si falla â†’ esperar 2s â†’ Intento 2
Intento 2 â†’ Si falla â†’ esperar 4s â†’ Intento 3
Intento 3 â†’ Si falla â†’ return null
```

**MÃ¡ximo timeout:** 60 segundos (para archivos muy grandes)

### Timeout DinÃ¡mico

```javascript
// Antes: 30s fijo para todos
// Ahora: proporcional al tamaÃ±o
const timeout = 10s + (tamaÃ±o_en_bytes / 1000) * 1s

Ejemplos:
- Archivo 500 chars: 10.5s timeout
- Archivo 5000 chars: 15s timeout
- Archivo 15000 chars: 25s timeout
```

---

## ðŸ”§ CAMBIOS EN INFRAESTRUCTURA

### 1. ConfiguraciÃ³n Servidor LLM (8GB VRAM)

**Antes:**
```bash
--ctx-size 32768 --parallel 4  # 4 slots Ã— 8K tokens = 32K total
```

**DespuÃ©s:**
```bash
--ctx-size 32768 --parallel 2  # 2 slots Ã— 16K tokens = 32K total
```

**CÃ¡lculo:**
- LFM2-Extract 1.2B Q8_0: ~1.2GB
- Overhead GPU/Vulkan: ~0.5GB
- Disponible para KV Cache: ~6.3GB
- LFM2 usa ~0.2MB/token (hÃ­brido SSM+Transformer)
- Total tokens: 6.3GB Ã· 0.2MB = ~31,500 tokens
- Con 2 slots: ~15,750 tokens por slot (margen seguro)

### 2. Cache movido a `.OmnySystemData/`

**Antes:** `.aver/cache.json`  
**DespuÃ©s:** `.OmnySystemData/cache.json`

**Consistencia:** Todos los datos del sistema ahora en un solo lugar.

### 3. Prompt Template Optimizado

**Antes:** ~200 lÃ­neas con instrucciones extensas  
**DespuÃ©s:** ~50 lÃ­neas compactas

**Cambios:**
- Instrucciones mÃ¡s directas
- Output format inline
- Eliminado texto redundante
- Enfoque en VALIDAR vs DESCUBRIR

---

## ðŸš€ NUEVO COMANDO CLI: analyze-file

```bash
omnysystem analyze-file src/components/Button.js
```

**Funcionalidad:**
- Analiza **un solo archivo** en ~1-2 segundos
- Usa contexto del proyecto existente
- Guarda en `.OmnySystemData/files/`
- Actualiza sistema incrementalmente

**Flujo:**
1. Carga system-map existente (si hay)
2. Parsea solo el archivo objetivo
3. Resuelve imports del archivo
4. Detecta conexiones semÃ¡nticas
5. Extrae metadatos
6. Guarda resultado

**Uso tÃ­pico:**
```bash
# AnÃ¡lisis completo inicial
omnysystem analyze .

# DespuÃ©s, anÃ¡lisis rÃ¡pido de archivo modificado
omnysystem analyze-file src/services/AuthService.js
```

---

## ðŸ“Š ESTADÃSTICAS TUNNEL VISION

| CategorÃ­a | Casos | Status |
|-----------|-------|--------|
| Basic Static (localStorage, events, globals) | 6/6 | âœ… 100% |
| Advanced (Workers, BroadcastChannel, WebSocket, SSE) | 6/6 | âœ… 100% |
| Metadata (JSDoc, async, errors, build flags) | 4/4 | âœ… 100% |
| CSS-in-JS (styled-components) | 1/4 | âš ï¸ 25% |
| TypeScript (interfaces, types) | 1/4 | âš ï¸ 25% |
| Redux/Context | 1/6 | âš ï¸ 17% |
| **TOTAL** | **19/30** | **63%** |

---

## ðŸ› BUGS CORREGIDOS

1. **Servidor LLM se caÃ­a con prompts grandes**
   - Causa: 4 slots Ã— 8K tokens = overflow con prompts de 7.5K+ tokens
   - SoluciÃ³n: 2 slots Ã— 16K tokens = margen seguro

2. **Metadata vacÃ­a consumÃ­a tokens**
   - Causa: Se incluÃ­a "JSDoc Contracts: 0" en el prompt
   - SoluciÃ³n: Filtrar metadata sin contenido

3. **Contexto saturado con imports irrelevantes**
   - Causa: LÃ­mite arbitrario de 3 imports
   - SoluciÃ³n: Mostrar TODOS con metadatos compactos

---

## ðŸ“ COMENTARIOS CRÃTICOS AGREGADOS

4 archivos clave tienen comentarios en MAYÃšSCULAS documentando la regla de oro:

1. `llm-analyzer.js` - buildPrompt()
2. `enricher/core.js` - Antes del loop de anÃ¡lisis
3. `enricher/context-builders.js` - buildFileSpecificContext()
4. `enricher/utils.js` - limitContextSize()

---

## ðŸ—ºï¸ ROADMAP PRÃ“XIMOS PASOS

### v0.4.3 (PrÃ³ximo)
- [ ] Completar CSS-in-JS (emotion, theme-ui)
- [ ] Completar TypeScript (generics, type guards)
- [ ] Completar Redux/Context (providers, consumers)
- [ ] Implementar modo "Ã¡rbol genealÃ³gico completo"

### v0.5.0 (FunciÃ³n)
- [ ] Activar OpciÃ³n C: anÃ¡lisis por funciÃ³n
- [ ] Detectar dependencias circulares a nivel de funciÃ³n
- [ ] OptimizaciÃ³n God Objects (archivos >500 lÃ­neas)

### v0.6.0 (Predictivo)
- [ ] Predecir breaking changes antes de editar
- [ ] Sugerir refactorizaciones automÃ¡ticas
- [ ] IntegraciÃ³n con IDE (VS Code extension)

---

## ðŸ”— ARCHIVOS MODIFICADOS

### Nuevos:
- `src/layer-b-semantic/enricher/index.js` (850 bytes)
- `src/layer-b-semantic/enricher/core.js` (14,085 bytes)
- `src/layer-b-semantic/enricher/context-builders.js` (12,896 bytes)
- `src/layer-b-semantic/enricher/mergers.js` (3,804 bytes)
- `src/layer-b-semantic/enricher/utils.js` (3,528 bytes)
- `src/layer-b-semantic/function-analyzer.js` (9,100 bytes)

### Modificados:
- `src/layer-b-semantic/semantic-enricher.js` (990 bytes, desde 33,000)
- `src/layer-b-semantic/llm-analyzer.js`
- `src/layer-a-static/cache/analysis-cache.js`
- `src/ai/scripts/start_brain_gpu.bat`
- `src/ai/ai-config.json`
- `omnysystem.js`

---

## ðŸ“ˆ MÃ‰TRICAS DE CÃ“DIGO

| MÃ©trica | Antes | DespuÃ©s |
|---------|-------|---------|
| LÃ­neas semantic-enricher.js | 820 | 30 (re-exports) |
| LÃ­neas totales capa B | ~2,500 | ~2,800 (+function-analyzer) |
| MÃ³dulos separados | 1 | 6 |
| Comentarios crÃ­ticos | 0 | 4 |
| Opciones de anÃ¡lisis | 1 (archivo) | 2 (archivo + funciÃ³n preparada) |

---

**Fin del changelog v0.4.2**
