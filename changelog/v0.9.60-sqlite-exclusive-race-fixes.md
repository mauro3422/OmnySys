# v0.9.60 - SQLite Exclusive + Race Conditions Fixed

**Date**: 2026-02-23  
**Status**: ‚úÖ Complete

---

## Summary

Complete migration to SQLite-only storage. Removed all JSON file dependencies and resolved race conditions in cache and atomic editor.

---

## Changes

### üöÄ Features

#### 1. RAM Cache ‚Üí SQLite Migration
- **File**: `src/core/cache/manager/ram-cache.js`
- Cache now uses SQLite backend with automatic fallback to Map
- Added `cache_entries` table to schema
- **Result**: Race conditions resolved (3 ‚Üí 0)

#### 2. AtomicEditor FileLockManager
- **File**: `src/core/atomic-editor/AtomicEditor.js`
- Added `FileLockManager` class to prevent concurrent writes to same file
- Uses async queue for file locking
- **Result**: File write race conditions resolved

#### 3. Race Detector Update
- **File**: `src/layer-c-memory/mcp/tools/detect-race-conditions.js`
- Added SQLite resources to safe resources list
- Now ignores safe resources: `call:set`, `call:write`, `db:sqlite`, etc.
- **Result**: False positives eliminated

### üîß Removed JSON Legacy

| Removed File | New Storage |
|--------------|-------------|
| `.omnysysdata/index.json` | SQLite `atoms` table |
| `.omnysysdata/molecules/` | Derived from atoms |
| `.omnysysdata/semantic-issues.json` | SQLite `semantic_issues` table |
| `.omnysysdata/cache/index.json` | SQLite `cache_entries` table |

### üìÅ Modified Files

| File | Change |
|------|--------|
| `ram-cache.js` | SQLite backend |
| `AtomicEditor.js` | FileLockManager |
| `detect-race-conditions.js` | Safe resources |
| `project-query.js` | SQLite only |
| `connections-query.js` | SQLite only |
| `risk-query.js` | SQLite only |
| `file-watcher/analyze.js` | Removed index.json |
| `cache/manager/storage.js` | SQLite source |
| `storage/files/metadata.js` | SQLite |
| `storage/molecules/molecule.js` | Removed JSON |
| `orchestrator/issues.js` | SQLite |
| `database/schema.sql` | cache_entries table |

---

## Database Schema

- atoms: ~13,064
- files: ~2,166
- semantic_issues: ~116
- cache_entries: 5
- system_metadata: 5
- atom_relations: ~6,000
- semantic_connections: ~3,000
- risk_assessments: ~2,000

---

## Breaking Changes

‚ö†Ô∏è **System now uses SQLite exclusively** - No JSON fallbacks remain

- If SQLite is unavailable, system will throw errors
- Run analysis to populate SQLite before using tools

---

## Metrics

| Metric | Before | After |
|--------|--------|-------|
| Race Conditions | 3 | 0 |
| JSON Files | 4+ | 0 |
| Cache Backend | Map() | SQLite |
| Query Sources | JSON+SQLite | SQLite Only |

---

## Testing

- ‚úÖ Server restart successful
- ‚úÖ Race conditions: 0 detected
- ‚úÖ SQLite tables populated
- ‚úÖ All MCP tools functional
