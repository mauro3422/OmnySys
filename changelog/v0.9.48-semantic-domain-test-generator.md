# v0.9.48 - Semantic Domain + Test Generator + Registry System

**Release Date**: 2026-02-21

## Summary

Major infrastructure improvements: Semantic Domain detection, Test Generator MCP tool, and centralized Registry system. This release adds intelligent metadata extraction and automated test generation capabilities.

---

## üÜï New Features

### 1. Semantic Domain Detection

**File**: `src/layer-a-static/extractors/metadata/semantic-domain.js`

Automatically detects what type of operation a function performs:
- JSON processing (JSON.parse, extractJSON, etc.)
- HTTP/API calls (fetch, axios, http.request)
- Filesystem operations (fs.readFile, fs.writeFile)
- String manipulation (regex, string methods)
- Validation (validate, isValid, check)
- Transformation (transform, convert, map)
- LLM processing (openai, anthropic, claude)
- Database operations (query, mongoose, prisma)

**Example output**:
```json
{
  "primary": "json",
  "confidence": 0.9,
  "purpose": "extract-json-from-text",
  "inputPatterns": ["json-string", "text-with-json", "json-array"],
  "outputPatterns": ["parsed-object", "json-object"]
}
```

### 2. Test Generator MCP Tool

**Files**: `src/layer-c-memory/mcp/tools/generate-tests/` (7 modules)

New MCP tools for automated test generation:
- `generate_tests` - Generate tests for a single function
- `generate_batch_tests` - Generate tests for multiple functions without coverage

**Features**:
- Uses semanticDomain for intelligent input generation
- Detects throw conditions from errorFlow
- Generates mocks based on callGraph dependencies
- Provides specific inputs for each domain (JSON strings for JSON functions, URLs for HTTP functions)

### 3. Extractor Registry System

**File**: `src/layer-a-static/extractors/metadata/registry.js`

Centralized registry for all metadata extractors with auto-discovery:
- `EXTRACTOR_REGISTRY` - 18 registered extractors
- `BASE_ATOM_FIELDS` - 22 base atom fields
- `getFieldToolCoverage()` - Auto-generated tool coverage map
- `getAvailableFields()` - All available metadata fields

**Benefits**:
- Adding new extractors: 2 steps (was 5)
- Auto-updates schema and tool coverage
- Single source of truth for all metadata

---

## üìÅ Files Changed

### New Files (28)

| File | Description |
|------|-------------|
| `AGENTS.md` | Rules for OpenCode AI assistant |
| `changelog/v0.9.47-massive-refactoring.md` | Previous version changelog |
| `src/ai/llm/json-cleaners.js` | JSON extraction utilities |
| `src/core/file-watcher/handlers/file-handlers.js` | File operation handlers |
| `src/core/file-watcher/handlers/metadata-cleanup.js` | Metadata cleanup logic |
| `src/core/file-watcher/handlers/relationships.js` | Relationship handlers |
| `src/layer-a-static/extractors/metadata/registry.js` | **Extractor registry** |
| `src/layer-a-static/extractors/metadata/semantic-domain.js` | **Semantic domain extractor** |
| `src/layer-a-static/pipeline/phases/atom-extraction/metadata/archetype-rules.js` | Archetype detection rules |
| `src/layer-b-semantic/atom-decider/decision-gates.js` | Decision gate logic |
| `src/layer-c-memory/mcp/tools/generate-tests/batch-generator.js` | Batch test generator |
| `src/layer-c-memory/mcp/tools/generate-tests/code-generator.js` | Test code generator |
| `src/layer-c-memory/mcp/tools/generate-tests/index.js` | Main entry point |
| `src/layer-c-memory/mcp/tools/generate-tests/input-generator.js` | Smart input generator |
| `src/layer-c-memory/mcp/tools/generate-tests/recommendations.js` | Test recommendations |
| `src/layer-c-memory/mcp/tools/generate-tests/source-analyzer.js` | Source code analyzer |
| `src/layer-c-memory/mcp/tools/generate-tests/test-analyzer.js` | Test pattern analyzer |
| `tests/examples/real-factory-example.test.js` | Real factory example |
| `tests/factories/extractor-test/base-builder.js` | Base test builder |
| `tests/factories/extractor-test/class-builder.js` | Class test builder |
| `tests/factories/extractor-test/code-sample-builder.js` | Code sample builder |
| `tests/factories/extractor-test/function-builders.js` | Function test builders |
| `tests/factories/real/MIGRATION_GUIDE.md` | Migration guide |
| `tests/factories/real/filesystem.factory.js` | Real filesystem factory |
| `tests/factories/real/index.js` | Factory exports |
| `tests/factories/real/project.factory.js` | Project factory |
| `tests/test-emoji-support.js` | Emoji support test |
| `tests/unit/cli/commands/check.real.test.js` | Real factory test example |

### Modified Files (15)

| File | Changes |
|------|---------|
| `CHANGELOG.md` | Updated with v0.9.47 |
| `src/ai/llm/response-cleaner.js` | Refactored |
| `src/core/atomic-editor/validators/syntax-validator.js` | UTF-8/emoji fix |
| `src/core/file-watcher/handlers.js` | Refactored to barrel export |
| `src/layer-a-static/extractors/metadata/index.js` | Added registry exports |
| `src/layer-a-static/pipeline/phases/atom-extraction/builders/metadata-builder.js` | Added semanticDomain |
| `src/layer-a-static/pipeline/phases/atom-extraction/extraction/atom-extractor.js` | Integrated semanticDomain |
| `src/layer-a-static/pipeline/phases/atom-extraction/metadata/archetype.js` | Refactored |
| `src/layer-b-semantic/atom-decider/index.js` | Refactored |
| `src/layer-c-memory/mcp/tools/get-atom-schema.js` | Dynamic tool coverage |
| `src/layer-c-memory/mcp/tools/get-function-details.js` | Added semanticDomain output |
| `src/layer-c-memory/mcp/tools/index.js` | Added new tools (30 total) |
| `tests/factories/README.md` | Updated documentation |
| `tests/factories/extractor-test/core-builders.js` | Refactored (529‚Üí15 lines) |

---

## üîß Technical Details

### Semantic Domain Detection

Detects 12 domain types with pattern matching:
- `json` - JSON.parse, extractJSON, res.json()
- `http` - fetch, axios, http.request
- `filesystem` - fs.readFile, path.join
- `parsing` - .parse(), regex, extract
- `validation` - validate, isValid, check
- `transformation` - .map(), .filter(), transform
- `string` - .split(), .join(), .replace()
- `async_flow` - async/await, Promise
- `event` - .on(), .emit(), addEventListener
- `crypto` - hash, encrypt, jwt
- `database` - .query(), SELECT, mongoose
- `llm` - openai, anthropic, gpt

### Test Generator Architecture

```
generate-tests/
‚îú‚îÄ‚îÄ index.js           ‚Üí Tool entry point
‚îú‚îÄ‚îÄ test-analyzer.js   ‚Üí Analyzes function for test patterns
‚îú‚îÄ‚îÄ input-generator.js ‚Üí Generates smart inputs using semanticDomain
‚îú‚îÄ‚îÄ code-generator.js  ‚Üí Generates test code
‚îú‚îÄ‚îÄ source-analyzer.js ‚Üí Reads source code for specific patterns
‚îú‚îÄ‚îÄ recommendations.js ‚Üí Calculates risk scores
‚îî‚îÄ‚îÄ batch-generator.js ‚Üí Batch processing
```

### Registry Benefits

**Before**: 5 steps to add extractor
1. Create extractor file
2. Export from index.js
3. Import in index.js
4. Add to extractAllMetadata()
5. Update FIELD_TOOL_COVERAGE

**After**: 2 steps
1. Create extractor file
2. Add entry to EXTRACTOR_REGISTRY

---

## üìä Metrics

| Metric | Value |
|--------|-------|
| Total MCP Tools | 30 (was 28) |
| Extractors Registered | 18 |
| Base Atom Fields | 22 |
| Domain Types Detected | 12 |
| New Files | 28 |
| Modified Files | 15 |
| Total Changes | 43 |

---

## üß™ Test Coverage

New test infrastructure:
- Real factories for filesystem testing
- Migration guide from mocks to real factories
- Example tests using semanticDomain

---

## Breaking Changes

None. All changes are backward compatible.

---

## Upgrade Notes

1. MCP Server needs restart after update
2. semanticDomain is automatically added to all atoms on re-analysis
3. generate_tests tool available immediately

---

## Contributors

- OpenCode AI Assistant (refactoring & new features)
- System validated with 0 breaking changes
