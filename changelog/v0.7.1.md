# Changelog v0.7.1 - Extended Release

**Fecha**: 2026-02-09  
**Estado**: Production Ready  
**C√≥digo**: `main`  

---

## üéØ Resumen Ejecutivo

Release extendido que incluye:

1. **Race Conditions Detector** - Activaci√≥n completa (8 TODOs implementados)
2. **Shadow Registry** - Sistema de linaje para archivos eliminados
3. **4 Nuevos Extractores** - Temporal, Type Contracts, Error Flow, Performance
4. **Logger Migration** - 475+ logs centralizados
5. **Meta-Validator** - 4 capas de validaci√≥n
6. **Auditor√≠a** - 99% veracidad verificada

---

## üìä M√©tricas Globales

| M√©trica | Valor | Estado |
|---------|-------|--------|
| TODOs implementados | 8/8 | ‚úÖ 100% |
| Race detector | 100% | ‚úÖ Funcional |
| Metadata extractors | 10 | ‚úÖ (6‚Üí10) |
| Shadows creados | 7 | ‚úÖ Nuevo |
| Logger migration | 475+ logs | ‚úÖ Completo |
| Tests nuevos | 27+ | ‚úÖ |
| Veracidad de datos | 99% | ‚úÖ Verificado |

---

## üêõ Bug Fixes (Post-Release)

### Fixed: MCP Server Cache Not Updating on Restart
**Fecha**: 2026-02-11  
**Archivos modificados**: 
- `src/layer-c-memory/mcp/core/analysis-checker.js`
- `src/layer-c-memory/mcp/tools/restart-server.js`

**Problemas identificados**:
1. **Cache no se actualizaba**: El sistema cargaba datos viejos de Layer A sin verificar cambios en el proyecto
2. **Archivos faltantes**: 180 archivos (30%) no estaban en el cach√©
3. **Referencias rotas**: Archivos referenciados pero no existentes en el cach√©
4. **Restart mataba el proceso**: `process.exit(0)` romp√≠a la conexi√≥n MCP

**Soluciones implementadas**:
- ‚úÖ **Detecci√≥n de cambios autom√°tica**: `scanCurrentFiles()` + `detectCacheChanges()` detectan nuevos/modificados/eliminados
- ‚úÖ **Re-an√°lisis inteligente**: Si hay cambios, fuerza re-an√°lisis de Layer A completo
- ‚úÖ **Reinicio sin matar proceso**: `restart_server` ahora reinicia componentes internos sin `process.exit()`
- ‚úÖ **Opci√≥n `reanalyze`**: Nueva flag para forzar re-an√°lisis completo

**Resultado**: 
- Archivos analizados: 415 ‚Üí **600** (+185 archivos)
- Cach√© actualizado autom√°ticamente en reinicios
- Conexi√≥n MCP estable durante reinicios

### Fixed: Metadata Flow & LLM Decision Gates
**Fecha**: 2026-02-11  
**Archivos modificados**: 
- `src/core/orchestrator/llm-analysis.js`
- `src/layer-b-semantic/prompt-engine/PROMPT_REGISTRY.js`

**Problemas identificados**:
1. **LLM se activaba para todos los arquetipos**: El sistema ignoraba los valores `requiresLLM` del registro
2. **No se respetaban los Gates de decisi√≥n**: Arquetipos como `facade`, `config-hub` y `entry-point` (que no necesitan LLM) se enviaban igual
3. **Desconexi√≥n entre arquetipos y analysis-decider**: La l√≥gica de bypass estaba implementada pero no se usaba

**Soluciones implementadas**:
- ‚úÖ **Sistema de 4 Gates**: Implementada funci√≥n `shouldUseLLM()` que respeta los valores del registro
  - **Gate 1**: Arquetipos `requiresLLM: true` ‚Üí Siempre LLM (god-object, dynamic-importer)
  - **Gate 2**: Arquetipos `requiresLLM: 'conditional'` ‚Üí Usar `analysis-decider.js` (orphan-module, singleton)
  - **Gate 3**: Arquetipos `requiresLLM: false` ‚Üí Bypass, 100% metadatos (facade, config-hub, entry-point)
  - **Gate 4**: Fallback a an√°lisis de conexiones resueltas
- ‚úÖ **Integraci√≥n con analysis-decider**: Ahora se verifican conexiones est√°ticas con confidence 1.0 antes de enviar a LLM

**Resultado**: 
- Archivos enviados a LLM: 89 ‚Üí **~10-15** (ahorro del 83%)
- Bypass rate: **~74 archivos** resueltos puramente por metadatos
- Feedback loop positivo: M√°s metadatos ‚Üí Menos LLM ‚Üí M√°s metadatos

### Fixed: File Watcher Auto-Update Layer A
**Fecha**: 2026-02-11  
**Archivos modificados**: 
- `src/core/orchestrator/lifecycle.js`
- `src/core/orchestrator/helpers.js`
- `src/core/analysis-worker.js`
- `src/layer-a-static/graph/builders/system-map.js`

**Problemas identificados**:
1. **File watcher no actualizaba Layer A**: Cuando hab√≠a cambios en archivos, solo se hac√≠a an√°lisis LLM, no se re-analizaba con Layer A
2. **Cach√© no se invalidaba**: Los cambios no se reflejaban en el mapa de dependencias
3. **Imports din√°micos invisibles**: 91 importaciones din√°micas no se trackeaban en el grafo

**Soluciones implementadas**:
- ‚úÖ **Re-an√°lisis autom√°tico**: El worker ahora re-analiza con Layer A ANTES de LLM
- ‚úÖ **Invalidaci√≥n de cach√©**: `_invalidateFileCache()` elimina archivos del cach√© cuando cambian
- ‚úÖ **Integraci√≥n single-file**: Usa `analyzeSingleFile()` para re-an√°lisis r√°pido
- ‚úÖ **Imports din√°micos en grafo**: Ahora se integran con confidence 0.8
- ‚úÖ **Actualizaci√≥n incremental**: El systemMap se actualiza con cada cambio

**Flujo completo ahora**:
1. File watcher detecta cambio
2. Se invalida cach√© del archivo
3. Se re-analiza con Layer A (single-file)
4. Se actualiza systemMap
5. Se hace LLM si es necesario

**Resultado**: 
- Cambios se reflejan inmediatamente en el mapa
- 91 imports din√°micos ahora visibles
- Precisi√≥n quir√∫rgica 100% operativa

---

## üìö Documentaci√≥n Detallada

Este changelog se ha dividido en archivos espec√≠ficos para mejor mantenibilidad:

| Documento | Contenido | L√≠neas |
|-----------|-----------|--------|
| [**v0.7.1-race-conditions.md**](./v0.7.1-race-conditions.md) | Race detector, TODOs implementados | ~150 |
| [**v0.7.1-shadow-registry.md**](./v0.7.1-shadow-registry.md) | Shadow Registry, 4 extractores, Connection Enricher | ~200 |
| [**v0.7.1-audit-verification.md**](./v0.7.1-audit-verification.md) | Auditor√≠a, Logger, Meta-Validator | ~200 |

---

## üöÄ Quick Start

### Verificar Extracci√≥n

```bash
node scripts/audit-extraction.js src/archivo.js
```

### Validar Proyecto

```bash
node scripts/validate-full.js .
```

### Ejecutar Tests

```bash
node --test src/**/__tests__/*.test.js
```

---

## üìÅ Archivos Principales

### Nuevos Sistemas

```
src/layer-c-memory/shadow-registry/
‚îú‚îÄ‚îÄ index.js              # Registry principal
‚îú‚îÄ‚îÄ lineage-tracker.js    # Trazabilidad
‚îî‚îÄ‚îÄ types.js              # Tipos y enums

src/layer-a-static/extractors/metadata/
‚îú‚îÄ‚îÄ temporal-connections.js   # Patrones temporales
‚îú‚îÄ‚îÄ type-contracts.js         # Contratos de tipos
‚îú‚îÄ‚îÄ error-flow.js             # Flujos de error
‚îú‚îÄ‚îÄ performance-impact.js     # Impacto de rendimiento
‚îî‚îÄ‚îÄ dna-extractor.js          # Fingerprints √∫nicos

src/layer-a-static/pipeline/enhancers/
‚îî‚îÄ‚îÄ connection-enricher.js    # Post-procesamiento
```

### Scripts de Auditor√≠a

```
scripts/
‚îú‚îÄ‚îÄ validate-full.js      # CLI de validaci√≥n
‚îî‚îÄ‚îÄ audit-extraction.js   # Auditor√≠a de extracci√≥n
```

---

## ‚úÖ Checklist de Lanzamiento

- [x] 8 TODOs de race conditions implementados
- [x] Shadow Registry funcional (7 shadows)
- [x] 4 nuevos extractores integrados
- [x] DNA extraction en pipeline
- [x] Connection Enricher operativo
- [x] Logger migration (475+ logs)
- [x] Meta-Validator 4 capas
- [x] Tests: 27+ nuevos
- [x] Auditor√≠a: 99% veracidad
- [x] Documentaci√≥n dividida (<300 l√≠neas cada archivo)

---

## üîó Referencias

- **Plan Maestro**: `PLAN_MAESTRO_CORRECCION.md`
- **Follow Up**: `AUDIT_FOLLOW_UP.md`
- **Audit Results**: `AUDIT_RESULTS.md`
- **Integration Summary**: `INTEGRATION_SUMMARY.md`
- **Arquitectura**: `docs/FISICA_DEL_SOFTWARE.md`

---

## üéØ Estado Final

**SISTEMA LISTO PARA PRODUCCI√ìN**

- ‚úÖ Todos los sistemas operativos
- ‚úÖ Alta veracidad de datos (99%)
- ‚úÖ Documentaci√≥n completa y dividida
- ‚úÖ Tests pasando
- ‚úÖ Auditor√≠a aprobada

---

**v0.7.1 - Race Conditions + Shadow Registry + 4 Extractores + Audit System. Sistema listo para producci√≥n.**
