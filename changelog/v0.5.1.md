# OmnySys v0.5.1 - Bug Fixes & MCP Optimization

**Fecha:** 2026-02-06  
**Tipo:** Bug Fix + Performance Optimization  
**Estado:** ‚úÖ Complete

---

## üêõ **BUGS CR√çTICOS CORREGIDOS**

### **1. Bloqueo del Event Loop durante Inicializaci√≥n**
**Problema:** El sistema bloqueaba la terminal durante minutos al iniciar el MCP debido a procesamiento secuencial.

**Archivos Modificados:**
- `src/core/orchestrator/lifecycle.js` - Inicializaci√≥n no bloqueante
- `src/core/orchestrator/llm-analysis.js` - Procesamiento paralelo por batches (10 archivos)
- `src/layer-a-static/pipeline/parse.js` - Parseo en paralelo por batches (20 archivos)
- `src/core/file-watcher/lifecycle.js` - Yield cada 50 archivos con `setImmediate()`

**Soluci√≥n:**
```javascript
// ANTES (bloqueante):
for (const file of files) {
  await processFile(file); // Bloquea cada iteraci√≥n
}

// DESPU√âS (no bloqueante):
for (let i = 0; i < files.length; i += BATCH_SIZE) {
  const batch = files.slice(i, i + BATCH_SIZE);
  await Promise.all(batch.map(f => processFile(f)));
  await new Promise(resolve => setImmediate(resolve)); // Yield
}
```

### **2. Inconsistencia de Rutas (`.OmnySysData` vs `.omnysysdata`)**
**Problema:** El c√≥digo usaba diferentes nombres de directorio, causando "datos no encontrados".

**Archivos Modificados:**
- `src/layer-c-memory/mcp-server.js` - 5 referencias corregidas
- `src/layer-c-memory/omnysysdata-generator.js` - Constante `OMNYSYSDATA_DIR`
- `src/layer-c-memory/populate-omnysysdata.js` - Rutas unificadas
- `src/layer-a-static/storage/storage-manager.js` - `DATA_DIR`

**Soluci√≥n:** Estandarizado todo a `.omnysysdata` (min√∫sculas con punto).

### **3. Inicio Lento del MCP (30s ‚Üí 250ms)**
**Problema:** El MCP repopulaba y recacheaba 433 archivos en CADA inicio.

**Cambios en `mcp-server.js`:**
- Lazy loading: Solo carga el √≠ndice al inicio
- Datos se cargan on-demand cuando se necesitan
- Eliminado cacheo upfront de metadata, conexiones y assessments

**Resultado:**
- **Antes:** 30+ segundos (repopulaba todo)
- **Ahora:** 247 milisegundos (solo √≠ndice)

---

## ‚ö° **OPTIMIZACIONES DE PERFORMANCE**

### **Batch Processing**
- Procesamiento paralelo con `Promise.all()`
- Batches de 10 archivos para LLM analysis
- Batches de 20 archivos para parsing
- Yield al event loop entre batches

### **Lazy Loading**
- Cache inicializado vac√≠o
- Datos se cargan bajo demanda
- Metadata del √≠ndice solo carga contadores b√°sicos

---

## üîß **CONFIGURACI√ìN MCP PARA OPENCODE**

**Archivo Creado:** `opencode.json`

```json
{
  "$schema": "https://opencode.ai/config.json",
  "mcp": {
    "omny-system": {
      "type": "local",
      "command": ["node", "src/layer-c-memory/mcp-server.js", "."],
      "enabled": true,
      "timeout": 30000
    }
  }
}
```

**Estado:** Configurado pero requiere investigaci√≥n de handshake con OpenCode.

---

## üìä **ESTAD√çSTICAS DEL SISTEMA**

- **Archivos Analizados:** 433
- **Funciones:** 943
- **Conexiones Sem√°nticas:** 4002
- **Archivos de Alto Riesgo:** 1
- **Archivos de Riesgo Medio:** 75

**Tiempo de Inicio:**
- Orchestrator: ~1.5s
- Cache (lazy): ~250ms
- **Total:** < 2 segundos

---

## üß™ **VERIFICACI√ìN**

```bash
# Test de inicio r√°pido
node src/layer-c-memory/mcp-server.js .

# Resultado esperado:
# ‚úÖ MCP Server Ready!
# Cache init time: ~250ms
# Using existing .omnysysdata/ (433 files)
```

---

## üìù **NOTAS T√âCNICAS**

### **APIs Corregidas:**
- `this.cache.ramCacheSet()` ‚Üí `this.cache.set()`
- `this.cache.getCacheStats()` ‚Üí `this.cache.getRamStats()`

### **Event Loop Yield:**
```javascript
// Patr√≥n aplicado en 4 archivos cr√≠ticos
await new Promise(resolve => setImmediate(resolve));
```

### **M√©todos de Inicializaci√≥n No-Bloqueantes:**
```javascript
// ANTES:
await this._analyzeComplexFilesWithLLM();

// DESPU√âS:
this._analyzeComplexFilesWithLLM().then(() => {
  console.log('‚úÖ LLM analysis queue ready');
}).catch(err => {
  console.error('‚ùå LLM analysis setup failed:', err.message);
});
```

---

## üöÄ **PR√ìXIMOS PASOS**

1. Investigar handshake MCP con OpenCode
2. Probar integraci√≥n completa con herramientas
3. Validar que las tools respondan en < 100ms

---

**Cambios Totales:** 10 archivos modificados  
**L√≠neas A√±adidas:** ~150  
**L√≠neas Eliminadas:** ~200  
**Bugs Cr√≠ticos Corregidos:** 3  
**Performance Improvement:** 120x m√°s r√°pido (30s ‚Üí 250ms)
