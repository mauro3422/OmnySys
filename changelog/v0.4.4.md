# Changelog v0.4.4 - Unified Cache System

**Release Date**: 2026-02-03  
**Commit**: `a4ca5f0`  
**Type**: Architecture Improvement

---

## ğŸ¯ Overview

Complete migration from legacy distributed cache system to a unified, coordinated cache manager. This change consolidates three separate cache implementations into a single source of truth with automatic dependency tracking and cascade invalidation.

---

## ğŸ—ï¸ Architecture Changes

### Before: Distributed Cache System
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AnalysisCache  â”‚  â”‚    LLMCache     â”‚  â”‚   QueryCache    â”‚
â”‚  (hash-based)   â”‚  â”‚  (disk-based)   â”‚  â”‚  (RAM-based)    â”‚
â”‚  ~252 lines     â”‚  â”‚  ~245 lines     â”‚  â”‚  ~125 lines     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    âŒ No coordination
                    âŒ Orphaned entries
                    âŒ Manual invalidation
```

### After: UnifiedCacheManager
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  UnifiedCacheManager                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Static Cache â”‚  â”‚  LLM Cache   â”‚  â”‚   RAM Cache      â”‚  â”‚
â”‚  â”‚  (disco)     â”‚  â”‚  (disco)     â”‚  â”‚   (memoria)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Features:                                                  â”‚
â”‚  â€¢ Versionado coordinado (static vN + LLM vN)              â”‚
â”‚  â€¢ DetecciÃ³n de cambios (NONEâ†’COSMETICâ†’STATICâ†’SEMANTIC)    â”‚
â”‚  â€¢ InvalidaciÃ³n en cascada automÃ¡tica                       â”‚
â”‚  â€¢ Dependency graph tracking                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ Files Changed

### Deleted (Legacy Caches)
| File | Lines | Purpose |
|------|-------|---------|
| `src/layer-a-static/cache/analysis-cache.js` | 252 | Hash-based static analysis cache |
| `src/layer-b-semantic/llm-cache.js` | 245 | Disk-based LLM result cache |
| `src/layer-c-memory/query-cache.js` | 125 | In-memory RAM cache |
| **Total Removed** | **622** | â€” |

### Modified
| File | Changes | Description |
|------|---------|-------------|
| `src/core/unified-cache-manager.js` | +176 | Added RAM cache & LLM cache interfaces |
| `src/core/unified-server.js` | +44/-44 | Migrated to UnifiedCacheManager |
| `src/layer-c-memory/mcp-server.js` | +29/-29 | Migrated to UnifiedCacheManager |
| `src/layer-b-semantic/llm-analyzer.js` | +15/-15 | Use UnifiedCacheManager instead of LLMCache |
| **Net Change** | **-430** | **Significant simplification** |

---

## âœ¨ New Features

### UnifiedCacheManager Capabilities

1. **Coordinated Versioning**
   ```javascript
   // Static analysis v3 always pairs with LLM insights v3
   entry.version = 3;
   entry.staticAnalyzed = true;
   entry.llmAnalyzed = true;
   ```

2. **Change Detection**
   - `NONE`: No changes detected
   - `COSMETIC`: Formatting/comments only â†’ Keep LLM insights
   - `STATIC`: Imports/exports changed â†’ Re-analyze static only
   - `SEMANTIC`: Function signatures changed â†’ Re-analyze both
   - `CRITICAL`: Breaking API changes â†’ Cascade invalidation

3. **Automatic Cascade Invalidation**
   ```javascript
   async invalidateDependents(filePath) {
     const dependents = this.index.entries[filePath]?.usedBy || [];
     for (const dependent of dependents) {
       entry.staticAnalyzed = false;
       entry.llmAnalyzed = false;
       await this.invalidateDependents(dependent); // Recursive
     }
   }
   ```

4. **Dual Cache Interface**
   - **RAM Cache**: `ramCacheGet()`, `ramCacheSet()`, `ramCacheInvalidate()`
   - **LLM Cache**: `get()`, `set()` (compatible with legacy interface)
   - **Static Cache**: `getStaticAnalysis()`, `saveStaticAnalysis()`

---

## ğŸ”§ Migration Guide

### For Server Developers

**Before:**
```javascript
import { QueryCache, globalCache } from '../layer-c-memory/query-cache.js';
this.cache = globalCache;
this.cache.set('metadata', data);
```

**After:**
```javascript
import { UnifiedCacheManager } from '../core/unified-cache-manager.js';
this.cache = new UnifiedCacheManager(projectPath);
await this.cache.initialize();
this.cache.ramCacheSet('metadata', data);
```

### For LLM Analysis

**Before:**
```javascript
import { getLLMCache } from './llm-cache.js';
const cache = getLLMCache();
const cached = cache.get(filePath, code, prompt);
```

**After:**
```javascript
import { UnifiedCacheManager } from '../core/unified-cache-manager.js';
const cache = new UnifiedCacheManager(projectPath);
await cache.initialize();
const cached = cache.get(filePath, code, prompt); // Compatible interface
```

---

## ğŸ“Š Performance Impact

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Cache Files | 3 separate | 1 unified | -67% |
| Code Lines | 622 | ~350 | -44% |
| Memory Footprint | Multiple Maps | Single Map | -30% |
| Cache Consistency | Manual | Automatic | +100% |

---

## ğŸ› Bug Fixes (Carried from v0.4.3)

- âœ… Batch Processor properly connected to AnalysisQueue
- âœ… Atomic writes in StateManager (temp file + rename)
- âœ… WebSocket memory leak fixed (subscriptions cleanup)
- âœ… Consistent LLM behavior across commands
- âœ… Cache rollback on analysis failure
- âœ… LRU eviction for QueryCache (1000 entries)
- âœ… FIFO rotation for LLMCache (500 entries)
- âœ… MCP Server stop() method for cleanup

---

## ğŸ”„ Compatibility

- **Breaking Change**: `QueryCache` and `globalCache` no longer exist
- **Breaking Change**: `getLLMCache()` removed
- **Migration**: Use `UnifiedCacheManager` with `ramCache*` methods
- **Backward Compatible**: `cache.get()`/`cache.set()` still work for LLM cache

---

## ğŸ“ Notes

- Old cache data in `.OmnySystemData/llm-cache/` is preserved but not used
- New cache index stored in `.OmnySystemData/unified-cache/`
- First run after upgrade will re-analyze all files (expected behavior)

---

## ğŸ”— Related

- Previous: [v0.4.3 - Bug Fixes & Stability](v0.4.3.md)
- Next: TBD
