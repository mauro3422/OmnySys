# v0.9.68 - MCP Tools Unification & Daemon Stability

**Date**: 2026-02-28
**Type**: Minor Release / Architectural Unification

## Overview

Auditor铆a absoluta y consolidaci贸n de las APIs MCP. El registro pas贸 de >30 herramientas dispersas a 16 super-herramientas agn贸sticas unificadas con arquitecturas enrutadas. Erradicaci贸n de p茅rdidas de conexi贸n entre interfaces por finalizaciones abruptas del servidor.

## Key Achievements

### 1. Arquitectura OOP para MCP Tools (Phase 15 & 17)
- **Implementaci贸n de Clases Base Anal铆ticas**: Creada `BaseMCPTool` para estandarizar el registro, validaci贸n y metadata de las herramientas.
- **Consultas de Grafo Pasivas**: Implementada clase abstracta `GraphQueryTool`. M谩s de 30 consultas legacy disgregadas fueron refactorizadas y enrutadas a trav茅s de esta clase, concentradas en los routers: `query_graph`, `traverse_graph` y `aggregate_metrics`.
- **Motor de Mutaciones Inyectado (AtomicMutationTool)**: Migrada toda la l贸gica imperativa destartalada de edici贸n at贸mica hacia la clase `AtomicMutationTool`. 
- **Estabilizaci贸n Transaccional (`TransactionManager`)**: Corregido un "Bug durmiente" donde las mutaciones (`atomic_write`, `atomic_edit`, `move_file`) fallaban en caliente porque llamaban est谩ticamente a `TransactionManager.startTransaction`. Ahora se instancian correcta y din谩micamente con `AtomicEditor`.

### 2. Unificaci贸n y Limpieza Extrema del Payload
- El registro total de MCP tools pas贸 de 30+ herramientas a un modelo cohesivo de **16 herramientas unificadas**.
- Reducido dr谩sticamente el uso excesivo de tokens al pasar el contexto de OmnySys hacia prompts de LLMs cliente.
- Sistema de rutas agn贸stico y normalizado de Windows Absolute paths a esquemas POSIX (`src/utils/...`), previniendo errores de `ENOENT` y escapes inv谩lidos (`C:\Dev\OmnySystem\C:\Dev\...`).

### 3. Daemon Stability & Graceful Restart (omny up)
- Integrado Express JSON Parser `express.json()` en el `mcp-http-server.js`.
- Nuevo endpoint HTTP Interno **`POST /restart`**. 
- Refactorizado el comando CLI `omny up`. Ahora, al detectar el daemon MCP, en vez de matar y reventar la conexi贸n del IDE remoto al daemon (lo que colgaba a VS Code), despacha una se帽al de hot-restart silenciosa al daemon principal.

### 4. Zero Memory Leaks del WASM Parser
- Intervenci贸n directa sobre los analizadores en caliente construidos con Tree-Sitter. 
- Al estar cruzados a un entorno WASM (C++ bridge), el Garbage Collector de JS V8 no lograba liberar los 谩rboles de sintaxis (`trees`). Insertado un desensamblador manual `tree.delete()` despu茅s de cada uso del AST, eliminando las famosas fugas graduales de RAM que congelaban el servidor tras d铆as iterando.

### 5. Estabilizaci贸n Definitiva en DataFlow Extractors
- Solventado el critical crash de capa A: `c.isNamed is not a function`.
- Mitigada la excepci贸n `Cannot read properties of undefined (reading 'slice')` en la utilidad AST `getOriginalSnippet`.
- Agregados fallbacks sem谩nticos y `Optional Chaining` en las visitas AST de los extractores Data-Flow y Usage, erradicando los _Uncaught Promise Exceptions_.

## Altered Files (Highlights)
| File | Action | Description |
|------|--------|-------------|
| `src/layer-c-memory/mcp/core/shared/base-tools/atomic-mutation-tool.js` | Refactor | Correcci贸n de instancias de TransactionManager. |
| `src/cli/commands/up.js` | Feat | Implementado Graceful Restart Request, evita cierres bruscos. |
| `src/layer-c-memory/mcp-http-server.js` | Feat | Endpoint `/restart`, motor de persistencia in-memory. |
| `src/layer-c-memory/mcp/tools/index.js` | Refactor | Registro MCP depurado y encogido a 16 super-herramientas. |
| `src/layer-a-static/extractors/data-flow/visitors/*.js` | Bugfix | Reemplazo de m茅todos ciegos por _Optional Chaining_ y chequeo de existencia nodal en TreeSitter. |
| `src/layer-a-static/ast/parser-v2.js` | Bugfix | Disparo de `tree.delete()` tras cierre del scope. |

## Post-Mortem Metrics
-  **Active Master Tools Tracked**: 16
- └ **WASM Memory Leaks Obliterated**: 1 
-  **Data Flow Analyzer Crash Resiliency**: 100%
-  **VS Code Daemon Disconnects/Crashes Prevented**: 100%
