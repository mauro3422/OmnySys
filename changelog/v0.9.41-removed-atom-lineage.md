# v0.9.41 - Removed Atom Lineage + get_removed_atoms MCP Tool

## Resumen

Cuando una función desaparece de un archivo (refactor, eliminación, renombre), el sistema
ahora la preserva como **snapshot histórico** en lugar de dejarla como fantasma o borrarla.
Esto permite detectar código duplicado antes de reimplementar algo que ya existió.

## Problema resuelto

Antes del v0.9.41:
- Función eliminada → quedaba en storage como "fantasma" (stale data) o se perdía
- No había forma de saber que `loadAllAtoms`, `findTargetAtom`, etc. existieron antes
- Riesgo de duplicar código que ya fue escrito y descartado

Desde el v0.9.41:
- Función eliminada → atom marcado con `lineage.status = 'removed'` (snapshot completo)
- `getAllAtoms()` filtra removidos por default → análisis activos no se contaminan
- `getRemovedAtoms()` expone el historial cuando lo necesitás
- Nuevo tool MCP `get_removed_atoms` accesible desde Claude

## Cambios técnicos

### `src/layer-a-static/pipeline/single-file.js`
- `saveAtoms()` ahora carga atoms previos del storage antes de guardar los nuevos
- Detecta funciones que desaparecieron: `prevAtomNames - newAtomNames`
- Las marca con `markAtomAsRemoved()` que preserva toda la metadata como snapshot
- Los atoms removidos quedan en el mismo archivo JSON, con `lineage.status = 'removed'`

### `src/layer-c-memory/storage/atoms/atom.js`
- `getAllAtoms(rootPath, { includeRemoved: false })` — nuevo parámetro opcional
- Por default excluye atoms con `lineage.status = 'removed'`
- Nueva función `getRemovedAtoms(rootPath, filePath?)` — solo atoms históricos

### `src/layer-c-memory/mcp/tools/get-removed-atoms.js` (nuevo)
- Tool MCP #20: `get_removed_atoms`
- Parámetros: `filePath`, `minComplexity`, `minCallers`, `limit`
- Retorna: `summary`, `insights`, `byFile`, `atoms[]`
- Incluye `dnaHash` de cada atom removido → permite detectar duplicados futuros

## Estructura del campo `lineage` en atom removido

```json
{
  "purpose": "REMOVED",
  "isDeadCode": true,
  "callerPattern": { "id": "removed", "label": "Eliminado" },
  "lineage": {
    "status": "removed",
    "removedAt": "2026-02-20T16:52:35.795Z",
    "lastSeenAt": "2026-02-20T14:29:45.030Z",
    "lastSeenLine": 45,
    "snapshotLOC": 24,
    "snapshotComplexity": 8,
    "snapshotCallers": 3,
    "dnaHash": "read-transform-return"
  }
}
```

## Caso de uso principal

```
Claude: "Voy a implementar una función para cargar todos los atoms..."
Sistema: get_removed_atoms() → "⚠️ loadAllAtoms existió en get-atom-society.js
         (removida el 2026-02-20, complexity 6, 0 callers, dnaHash: read-persist-return)"
Claude: "Esa lógica ya existe en storage/atoms/atom.js::getAllAtoms — usá esa"
```

## Total tools MCP: 20
