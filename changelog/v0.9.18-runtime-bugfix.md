# v0.9.18 - Runtime Bugfix: MCP Server Startup Errors (2026-02-18)

## Resumen

Correcci√≥n de **6 bugs reales** identificados directamente en los logs de runtime del servidor MCP al arrancar. Todos los bugs fueron detectados analizando los logs de inicio, corregidos en el c√≥digo fuente y cubiertos con tests nuevos.

**Resultado**: `293 test files ¬∑ 4308 tests passing ¬∑ 0 failed`

---

## Bugs Corregidos

### üêõ Bug 1 ‚Äî Double-trigger LLM analysis
**Archivo**: `src/core/orchestrator/lifecycle/init/main.js`

**S√≠ntoma**: `_analyzeComplexFilesWithLLM` se llamaba dos veces durante el arranque. El health-checker de LLM disparaba el an√°lisis antes de que el flag `_llmAnalysisTriggered` fuera seteado.

**Fix**: El flag se setea en `true` **antes** de la llamada async, con reset a `false` solo si la llamada falla.

```js
// ANTES ‚Äî flag seteado despu√©s (race condition)
this._startLLMHealthChecker();
this._analyzeComplexFilesWithLLM().then(() => { ... });

// DESPU√âS ‚Äî flag seteado ANTES
this._llmAnalysisTriggered = true;
this._analyzeComplexFilesWithLLM()
  .then(() => { logger.info("‚úÖ LLM analysis queue ready"); })
  .catch(err => {
    logger.error("‚ùå LLM analysis setup failed:", err.message);
    this._llmAnalysisTriggered = false; // reset solo en error
  });
```

---

### üêõ Bug 2 ‚Äî Parse error en `omnysystem.js` (pipeline operator `|>`)
**Archivo**: `src/layer-a-static/extractors/data-flow/index.js`

**S√≠ntoma**: El parser Babel fallaba al analizar `omnysystem.js` porque usa sintaxis `|>` (pipeline operator, stage-3) que no estaba en la lista de plugins.

**Fix**: Se agrega el plugin `pipelineOperator` con la propuesta `hack` a los PARSER_OPTIONS.

```js
// A√ëADIDO a PARSER_OPTIONS.plugins:
['pipelineOperator', { proposal: 'hack', topicToken: '#' }]
```

---

### üêõ Bug 3 ‚Äî `import() assert { type: 'json' }` roto en Node 22
**Archivo**: `src/layer-b-semantic/prompt-engine/core/schema-resolver.js`

**S√≠ntoma**: En Node 22, `import(url, { assert: { type: 'json' } })` ya no funciona, causando "No schema found for orphan-module" en los logs.

**Fix**: Reemplazado por `fs.readFile + JSON.parse`.

```js
// ANTES (Node 22 roto):
const schema = await import(schemaUrl, { assert: { type: 'json' } });

// DESPU√âS (compatible Node 18+):
const content = await readFile(schemaPath, 'utf8');
const schema = JSON.parse(content);
```

---

### üêõ Bug 4 ‚Äî Import DEPRECATED: `metadata-contract.js`
**Archivos**: `src/core/orchestrator/llm-analysis.js`, `src/core/jobs/JobAnalyzer.js`

**S√≠ntoma**: Ambos archivos importaban desde `metadata-contract.js` (wrapper deprecated), en lugar del m√≥dulo real.

**Fix**: Path actualizado en ambos archivos.

```js
// ANTES:
import('../../layer-b-semantic/metadata-contract.js')

// DESPU√âS:
import('../../layer-b-semantic/metadata-contract/index.js')
```

---

### üêõ Bug 5 ‚Äî `JSON.stringify(undefined).substring()` ‚Üí TypeError
**Archivo**: `src/layer-b-semantic/llm-analyzer/response-normalizer.js` (l√≠nea 22)

**S√≠ntoma**: `JSON.stringify(undefined)` devuelve `undefined` (no un string), y llamar `.substring()` sobre `undefined` lanza `TypeError: Cannot read properties of undefined`.

**Fix**: Optional chaining + nullish coalescing.

```js
// ANTES:
JSON.stringify(response).substring(0, 200)

// DESPU√âS:
JSON.stringify(response)?.substring(0, 200) ?? '(undefined)'
```

---

### üêõ Bug 6 ‚Äî `confidence: 0.0` tratado como "sin valor" (falsy JS)
**Archivo**: `src/layer-b-semantic/llm-analyzer/response-normalizer.js` (l√≠nea ~35)

**S√≠ntoma**: `0.0 || 0.8` eval√∫a a `0.8` porque `0.0` es falsy en JavaScript. Un LLM que devuelve confianza `0.0` (certeza cero) era tratado como confianza `0.8` (alta confianza), y el archivo pasaba el umbral incorrectamente.

**Fix**: Usar `??` (nullish coalescing) en lugar de `||`.

```js
// ANTES (INCORRECTO ‚Äî 0.0 es falsy):
const confidence = baseResponse.confidence || response.confidence || 0.8;

// DESPU√âS (CORRECTO ‚Äî solo fallback para null/undefined):
const confidence = baseResponse.confidence ?? response.confidence ?? 0.8;
```

---

## Tests Nuevos Creados

| Archivo | Descripci√≥n | Tests |
|---------|-------------|-------|
| `tests/unit/core/orchestrator/llm-trigger.test.js` | Guards del double-trigger + `_calculateLLMPriority` | ~12 |
| `tests/unit/layer-a-static/extractors/data-flow-parser-plugins.test.js` | Plugin `pipelineOperator` + otros syntax plugins | ~8 |
| `tests/unit/layer-b-semantic/prompt-engine/core/schema-resolver.test.js` | `resolveSchema`, `hasSchema`, `listAvailableSchemas`, `preloadSchemas`, `getSchemaSync` | ~15 |
| `tests/unit/layer-b-semantic/llm-analyzer/response-normalizer.test.js` | `normalizeResponse` (umbrales, fallbacks, campos), `normalizeSharedStateFromSimple`, `extractValidFilePaths` | ~31 |

---

## Impacto en Tests

| M√©trica | Antes | Despu√©s |
|---------|-------|---------|
| Test Files | 289 passed, **2 failed** | **293 passed**, 0 failed |
| Tests | 4306 passed, **2 failed** | **4308 passed**, 0 failed |
| Skipped | 35 | 35 |

---

## Archivos Modificados

### Source
- `src/core/orchestrator/lifecycle/init/main.js`
- `src/layer-a-static/extractors/data-flow/index.js`
- `src/layer-b-semantic/prompt-engine/core/schema-resolver.js`
- `src/core/orchestrator/llm-analysis.js`
- `src/core/jobs/JobAnalyzer.js`
- `src/layer-b-semantic/llm-analyzer/response-normalizer.js`

### Tests (nuevos)
- `tests/unit/core/orchestrator/llm-trigger.test.js`
- `tests/unit/layer-a-static/extractors/data-flow-parser-plugins.test.js`
- `tests/unit/layer-b-semantic/prompt-engine/core/schema-resolver.test.js`
- `tests/unit/layer-b-semantic/llm-analyzer/response-normalizer.test.js`
