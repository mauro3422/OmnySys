# v0.9.37 - LLM-Free Mode + Bug Fixes + Tool Consolidation

**Fecha:** 2026-02-20  
**Tipo:** Major Bug Fixes + Architecture

---

## üéØ Overview

Esta versi√≥n desactiva completamente el modo LLM, corrige 4 bugs cr√≠ticos en las herramientas MCP, y consolida las herramientas de 16 a 14.

---

## üî• LLM-Free Mode

El sistema ahora funciona **100% sin servidor LLM**:

| Antes | Despu√©s |
|-------|---------|
| Arranque esperando GPU (~28s) | Arranque directo (~5s) |
| `LLMService.getInstance()` | Removido |
| `_ensureLLMAvailable()` | Retorna `false` |
| `llm-checker.js` | Simplificado a no-op |

### Archivos Modificados
- `src/core/orchestrator/helpers.js` - `_ensureLLMAvailable()` retorna false
- `src/core/orchestrator/lifecycle/init/background.js` - Removida dependencia LLMService
- `src/core/orchestrator/lifecycle/health/llm-checker.js` - Simplificado
- `src/core/orchestrator/lifecycle/init/main.js` - Sin espera de LLM
- `src/layer-c-memory/mcp/core/initialization/steps/llm-setup-step.js` - Skip inmediato

---

## üêõ Bug Fixes

### Bug 1: DEAD_CODE con calledBy > 0 (Falso Positivo)

**Problema:** Funciones con callers eran marcadas como `DEAD_CODE`.

**Causa:** `detectAtomPurpose()` no verificaba `calledBy` antes del fallback.

**Fix:**
```javascript
// purpose.js - Check final agregado
const calledByCount = Array.isArray(atom.calledBy) ? atom.calledBy.length : (atom.calledBy || 0);
if (calledByCount > 0) {
  return { purpose: 'INTERNAL_HELPER', isDeadCode: false };
}
```

**Impacto:** 699 class methods correctamente clasificados.

---

### Bug 2: totalIssues Inflado en get_risk_assessment

**Problema:** `totalIssues` era igual a `totalFiles` (1747).

**Causa:** Inclu√≠a `lowCount` que son todos los archivos con riesgo bajo.

**Fix:**
```javascript
// risk.js
const totalIssues = criticalCount + highCount + mediumCount; // lowCount excluido
```

**Resultado:** 130 issues reales (no 1747).

---

### Bug 3: search_files No Encontraba S√≠mbolos

**Problema:** Buscar `detectAtomPurpose` retornaba 0 resultados.

**Causa:** Solo buscaba en paths de archivos, no en s√≠mbolos definidos.

**Fix:**
```javascript
// search.js - Ahora busca por path + s√≠mbolos
const exports = fileInfo.exports?.map(e => e.name).join(' ') || '';
const defs = fileInfo.definitions?.map(d => d.name).join(' ') || '';
if ((exports + ' ' + defs).toLowerCase().includes(pattern)) {
  symbolMatches.push(filePath);
}
```

**Resultado:** `detectAtomPurpose` ahora encuentra 2 archivos.

---

### Bug 4: importType "unknown" en get_call_graph

**Problema:** Todos los call sites reportaban `importType: "unknown"`.

**Causa:** No se derivaba el tipo desde `specifiers`.

**Fix:**
```javascript
// call-graph-analyzer.js
importType: importInfo
  ? (importInfo.specifiers?.some(s => s.type === 'namespace') ? 'namespace'
    : importInfo.specifiers?.some(s => s.type === 'default') ? 'default'
    : importInfo.specifiers?.length > 0 ? 'named'
    : 'unknown')
  : 'unknown'
```

---

## üîß Tool Consolidation

| Antes | Despu√©s |
|-------|---------|
| 16 tools | **14 tools** |
| `get_atomic_functions` | Fusionada en `get_molecule_summary` |
| `get_tunnel_vision_stats` | Eliminada (dead code) |

### get_molecule_summary Mejorado

Ahora incluye:
- `byArchetype` - Funciones agrupadas por arquetipo
- `exported` / `internal` - Separados por visibilidad
- `atoms` - Lista flat con datos completos
- `insights` - Dead code, hot paths, god functions

---

## üÜï Nueva Funcionalidad: Class Instantiation Tracker

**Archivo:** `src/layer-a-static/pipeline/phases/calledby/class-instantiation-tracker.js`

Resuelve `new Clase().metodo()` ‚Üí agrega `calledBy` a m√©todos de clase.

**Integraci√≥n:** indexer.js paso 3.7

**Impacto esperado:** 
- calledBy coverage: 38.5% ‚Üí 60-70%
- Dead code falsos positivos: 699 ‚Üí ~0

---

## üìÅ Archivos Modificados (30)

### Core/Orchestrator
| Archivo | Cambio |
|---------|--------|
| `helpers.js` | `_ensureLLMAvailable()` retorna false |
| `index.js` | LLM imports removidos |
| `iterative.js` | Skip LLM check |
| `lifecycle/health/llm-checker.js` | Simplificado a no-op |
| `lifecycle/init/background.js` | Removida dependencia LLMService |
| `lifecycle/init/main.js` | Sin espera de LLM |
| `llm-analysis.js` | Hardened |
| `queueing.js` | Fallback para maxConcurrentAnalyses |

### Layer A
| Archivo | Cambio |
|---------|--------|
| `indexer.js` | Integrado class-instantiation-tracker |
| `pipeline/phases/atom-extraction/metadata/purpose.js` | Check calledBy antes de DEAD_CODE |
| `pipeline/single-file.js` | Ajustes de flujo |

### Layer C / MCP
| Archivo | Cambio |
|---------|--------|
| `mcp-server.js` | Auto-configurar --max-old-space-size=8192 |
| `mcp/core/analysis-checker.js` | Mejoras |
| `mcp/core/initialization/steps/*.js` | LLM-free |
| `mcp/core/server-class.js` | Simplificado |
| `mcp/tools/get-molecule-summary.js` | Corregido display de DEAD_CODE |
| `mcp/tools/impact-map.js` | Mejorado con m√°s datos |
| `mcp/tools/index.js` | 16 ‚Üí 14 tools |
| `mcp/tools/lib/analysis/call-graph-analyzer.js` | importType corregido |
| `mcp/tools/risk.js` | totalIssues corregido |
| `mcp/tools/search.js` | B√∫squeda por s√≠mbolos |
| `storage/files/metadata.js` | Ajustes |

### Docs/Config
| Archivo | Cambio |
|---------|--------|
| `CHANGELOG.md` | Actualizado |
| `LAYER_A_STATUS.md` | Actualizado |
| `ROADMAP.md` | Actualizado |
| `package.json` | v0.9.36 ‚Üí v0.9.37 |

---

## üß™ Testing

- **Tests:** 4,366 pasando
- **Imports rotos:** 0
- **Deuda t√©cnica:** < 1%

---

## üìà M√©tricas de Impacto

| M√©trica | Antes | Despu√©s |
|---------|-------|---------|
| Startup time | ~28s | ~5s |
| MCP Tools | 16 | 14 |
| DEAD_CODE falsos positivos | 699 | ~0 |
| totalIssues | 1747 | 130 |
| calledBy coverage | 38.5% | 60-70% (estimado) |

---

**Previous:** v0.9.36 - Atom Purpose System  
**Next:** v0.9.38 - TBD