# Changelog v0.4.5 - MCP Server Modular Architecture

**Release Date**: 2026-02-04  
**Commits**: `f3c9e56` â†’ `c2b54d8`  
**Type**: Architecture Refactor + LLM Integration

---

## ğŸ§  Architecture Philosophy

> **"Metadata + IA = 95% Coverage"**

Este release establece el principio fundamental: **Layer A (Metadata) detecta patrones sospechosos, Layer B (IA) verifica hipÃ³tesis**.

### Ejemplo de flujo:
```
Metadata: "DetectÃ© import() con variable: `./modules/${moduleName}`"
    â†“
IA: "BasÃ¡ndome en el contexto, moduleName âˆˆ {'user', 'admin', 'auth'}"
    â†“
Confidence: 85% â†’ Agregar conexiones probables al grafo
```

Esto aplica a:
- **Dynamic imports** â†’ IA infiere valores posibles
- **Eventos dinÃ¡micos** â†’ IA busca listeners similares
- **DI implÃ­cito** â†’ IA mapea register() â†” get()
- **CÃ³digo muerto** â†’ IA confirma que no hay referencias ocultas

---

## ğŸ¯ Overview

**MAJOR ARCHITECTURE CHANGE**: The MCP Server is now the unified entry point of the entire system. The Orchestrator is no longer a standalone server but an internal component controlled by the MCP Server.

This enables the workflow you wanted: the user installs the MCP, and everything happens automatically.

---

## ğŸ—ï¸ Modular MCP Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MCP SERVER (Entry Point)                     â”‚
â”‚              node src/layer-c-memory/mcp/index.js              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  src/layer-c-memory/mcp/                                        â”‚
â”‚  â”œâ”€â”€ index.js              â†’ Entry point (argv, lifecycle)     â”‚
â”‚  â”œâ”€â”€ server.js             â†’ MCP protocol + initialization     â”‚
â”‚  â”œâ”€â”€ llm-starter.js        â†’ Start llama-server.exe (SSoT)    â”‚
â”‚  â””â”€â”€ tools/                â†’ Individual tool handlers          â”‚
â”‚      â”œâ”€â”€ index.js          â†’ Tool registry                    â”‚
â”‚      â”œâ”€â”€ impact-map.js     â†’ get_impact_map                   â”‚
â”‚      â”œâ”€â”€ analyze-change.js â†’ analyze_change                   â”‚
â”‚      â”œâ”€â”€ connection.js     â†’ explain_connection               â”‚
â”‚      â”œâ”€â”€ risk.js           â†’ get_risk_assessment              â”‚
â”‚      â”œâ”€â”€ search.js         â†’ search_files                     â”‚
â”‚      â””â”€â”€ status.js         â†’ get_server_status                â”‚
â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  INITIALIZATION FLOW (Sequential + Blocking)                   â”‚
â”‚                                                                 â”‚
â”‚  STEP 1: AI Server Setup                                       â”‚
â”‚    â€¢ Check LLM health on port 8000                             â”‚
â”‚    â€¢ If not running: spawn new terminal window                 â”‚
â”‚    â€¢ BLOCK until health check passes (2min max)                â”‚
â”‚    â€¢ âœ… LLM is ready! (GPU mode)                               â”‚
â”‚                                                                 â”‚
â”‚  STEP 2: Initialize Orchestrator                               â”‚
â”‚    â€¢ AnalysisQueue, AnalysisWorker, FileWatcher                â”‚
â”‚    â€¢ _syncProjectFiles(): detecta archivos nuevos              â”‚
â”‚    â€¢ Agrega faltantes a la cola con prioridad LOW              â”‚
â”‚    â€¢ Start processing loop                                     â”‚
â”‚                                                                 â”‚
â”‚  STEP 3: Initialize Cache                                      â”‚
â”‚    â€¢ UnifiedCacheManager.loadIndex()                           â”‚
â”‚                                                                 â”‚
â”‚  STEP 4: Check Analysis Status                                 â”‚
â”‚    â€¢ Si NO hay anÃ¡lisis â†’ startBackgroundIndexing()            â”‚
â”‚    â€¢ Layer A corre COMPLETO (metadata + semantic static)       â”‚
â”‚    â€¢ Layer B corre condicionalmente (skipLLM flag)             â”‚
â”‚                                                                 â”‚
â”‚  STEP 5: MCP Tools Ready                                       â”‚
â”‚    â€¢ Server.connect(transport)                                 â”‚
â”‚    â€¢ Listening on stdio                                        â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LAYER ARCHITECTURE (Metadata + IA)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Layer A: Static Analysis (SIEMPRE)                            â”‚
â”‚    â”œâ”€â”€ Parser: AST determinÃ­stico                              â”‚
â”‚    â”œâ”€â”€ Dependencies: imports/exports                           â”‚
â”‚    â”œâ”€â”€ Semantic Detection (Phase 3.5):                         â”‚
â”‚    â”‚   â”œâ”€â”€ Shared state (global, localStorage)                â”‚
â”‚    â”‚   â”œâ”€â”€ Event patterns (emit/on, addEventListener)         â”‚
â”‚    â”‚   â”œâ”€â”€ Side effects                                       â”‚
â”‚    â”‚   â”œâ”€â”€ Risk scores                                        â”‚
â”‚    â”‚   â””â”€â”€ Broken connections (workers, URLs)                 â”‚
â”‚    â””â”€â”€ Storage: system-map-enhanced.json                       â”‚
â”‚                                                                 â”‚
â”‚  Layer B: LLM Enrichment (~20% de casos)                       â”‚
â”‚    â””â”€â”€ Se activa cuando:                                       â”‚
â”‚        â€¢ skipLLM = false (config)                             â”‚
â”‚        â€¢ Hay conexiones ambiguas                               â”‚
â”‚        â€¢ Archivo es "hotspot" de riesgo                        â”‚
â”‚    â””â”€â”€ Enriquece: conexiones semÃ¡nticas con confidence score   â”‚
â”‚                                                                 â”‚
â”‚  Layer C: Query Runtime (MCP Tools)                            â”‚
â”‚    â””â”€â”€ Usa metadatos de A + B para responder queries           â”‚
â”‚    â””â”€â”€ Auto-queue si archivo no estÃ¡ analizado                 â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ¨ Key Features

### 1. Unified Entry Point

**Before** (Manual steps):
```bash
# Step 1: Index project manually
node src/layer-a-static/indexer.js /project

# Step 2: Start MCP server separately
node src/layer-c-memory/mcp-server.js /project
```

**After** (Single command):
```bash
# Everything happens automatically
node src/layer-c-memory/mcp-server.js /project
```

### 2. Auto-Index on Startup

If no analysis data exists, the server:
1. Starts background indexing immediately
2. Continues to serve requests (non-blocking)
3. Tools work as data becomes available

### 3. Smart Tool Behavior

```javascript
// If file not analyzed, auto-queue as CRITICAL
const impact = await get_impact_map("CameraState.js");
// Console output:
// ğŸš¨ File not analyzed: CameraState.js
// â³ Queueing as CRITICAL priority...
// âœ… Analysis completed for: CameraState.js
// â†’ Returns impact map
```

### 4. Internal Orchestrator

The Orchestrator is now a component, not a server:

```javascript
class CogniSystemMCPServer {
  constructor(projectPath) {
    // ğŸ”¥ Orchestrator as internal component
    this.orchestrator = new Orchestrator(projectPath);
  }
  
  async getImpactMap(filePath) {
    if (!await this.orchestrator.isAnalyzed(filePath)) {
      // Auto-analyze and wait
      return await this.orchestrator.analyzeAndWait(filePath);
    }
    // Return cached data
  }
}
```

---

## ğŸ“¦ New Files

| File | Description |
|------|-------------|
| `src/core/orchestrator.js` | Reusable Orchestrator component (queue, worker, watcher) |

## ğŸ“ Modified Files

| File | Changes |
|------|---------|
| `src/layer-c-memory/mcp-server.js` | Now uses internal Orchestrator, auto-indexing, smart tools |

---

## ğŸ”§ New Orchestrator API

```javascript
import { Orchestrator } from './orchestrator.js';

const orchestrator = new Orchestrator(projectPath);

// Initialize
await orchestrator.initialize();

// Check if analyzed
const isAnalyzed = await orchestrator.isAnalyzed("file.js");

// Analyze and wait (blocking)
const result = await orchestrator.analyzeAndWait("file.js", timeoutMs);

// Start background indexing
orchestrator.startBackgroundIndexing();

// Get status
const status = orchestrator.getStatus();

// Stop
await orchestrator.stop();
```

---

## ğŸ­ New MCP Tools

### get_server_status()

Returns complete server status including orchestrator state:

```javascript
{
  initialized: true,
  orchestrator: {
    isRunning: true,
    isIndexing: false,
    indexingProgress: 100,
    currentJob: null,
    queueSize: 0
  },
  metadata: { totalFiles: 150, totalFunctions: 450 },
  cache: { entryCount: 150, memoryUsage: "2.4 MB" }
}
```

---

## ğŸš€ Usage Flow

### For AI (Claude)

1. **User says**: "Install OmnySystem"
2. **AI installs**: `npm install omny-system`
3. **AI configures**: Add MCP server config
4. **AI starts**: `node mcp-server.js /project`
5. **Server ready**: Tools available immediately
6. **AI queries**: `get_impact_map("CameraState.js")`
7. **If not analyzed**: Auto-queues and waits
8. **Returns**: Complete impact analysis

### For User

```bash
# Just one command - everything happens automatically
node src/layer-c-memory/mcp-server.js /my-project

# Output:
# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
# â•‘     CogniSystem MCP Server v3.0.0                         â•‘
# â•‘     Entry Point Ãšnico - IA-Native Architecture            â•‘
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 
# STEP 0: Initialize Orchestrator
#   âœ“ Orchestrator ready
# 
# STEP 1: AI Server Setup
#   âœ“ LLM server already running
# 
# STEP 2: Initialize Data Structure
#   âœ“ omnysysdata/ already exists
# 
# STEP 3: Load Existing Data
#   âœ“ Files analyzed: 150
#   âœ“ Connections found: 320
# 
# STEP 4: Load into Cache
#   âœ“ Metadata cached
#   âœ“ Connections cached
#   âœ“ Risk assessment cached
# 
# âœ… MCP Server Ready!
# 
# ğŸ”§ Available tools:
#    â€¢ get_impact_map(filePath)
#    â€¢ analyze_change(filePath, symbolName)
#    â€¢ explain_connection(fileA, fileB)
#    â€¢ get_risk_assessment(minSeverity)
#    â€¢ search_files(pattern)
#    â€¢ get_server_status()
# 
# ğŸ’¡ If a file is not analyzed, it will be auto-queued as CRITICAL
```

---

## ğŸ“Š Cobertura de Conexiones (Current vs Target)

| Tipo de ConexiÃ³n | Actual | Target | Estrategia |
|-----------------|--------|--------|-----------|
| Imports/Exports (sintÃ¡cticas) | ~98% | 99% | Parser AST - determinÃ­stico |
| Eventos estÃ¡ndar | ~85% | 95% | + Mejores extractores de patrones |
| Shared State | ~75% | 90% | + Static extraction + IA verification |
| Side Effects | ~70% | 85% | + Metadata tagging |
| CSS-in-JS / Styled | ~60% | 80% | + Regex + AST + IA |
| Redux/Context | ~65% | 85% | + Patrones especÃ­ficos + IA |
| WebSocket/Workers | ~80% | 90% | Already good |
| Dynamic imports (`import()`) | ~40% | 75% | **Metadata + IA** |
| Eventos dinÃ¡micos | ~30% | 70% | **Metadata + IA** |
| DI implÃ­cito | ~20% | 65% | **Metadata + IA** |
| CÃ³digo muerto | ~50% | 80% | **IA confirmation** |
| Eval/Code generation | ~5% | 10% | Imposible estÃ¡tico |
| **TOTAL** | **~80%** | **~95%** | |

### ğŸ¯ CÃ³mo llegamos al 95%:

1. **Mejorar Layer A** (+5%): MÃ¡s extractores de metadata, incluso para casos "dinÃ¡micos"
2. **Expandir Layer B** (+5%): MÃ¡s triggers de LLM, confidence scoring
3. **Layer D (nuevo)** (+5%): Runtime instrumentation (opcional)

## ğŸ”‘ Concepto Clave: Metadata + IA

**NO es**: "La IA hace todo el trabajo"

**SÃ es**: "La metadata detecta patrones, la IA verifica hipÃ³tesis"

```javascript
// Ejemplo: Evento dinÃ¡mico
// Metadata (Layer A):
{
  file: "GameEvents.js",
  dynamicEvents: [
    { 
      pattern: "`player:${playerId}:update`",
      type: "template_literal",
      variables: ["playerId"],
      confidence: null  // pendiente de verificaciÃ³n
    }
  ]
}

// IA (Layer B) verifica:
"Busco listeners de eventos que incluyan 'player' y 'update'"
â†’ Encontrado: "player:joined", "player:left"
â†’ HipÃ³tesis: El evento probablemente sea escuchado en PlayerStore
â†’ Confidence: 78%

// Resultado final:
{
  source: "GameEvents.js",
  target: "PlayerStore.js",
  type: "probable_event_connection",
  confidence: 0.78,
  verifiedBy: "llm"
}
```

## âš ï¸ Breaking Changes

- **MCP Server** now modular structure (`mcp/`) 
- **Orchestrator** is internal component (not standalone)
- **Auto-sync** on startup: queues missing files automatically
- **LLM blocking**: waits for health check before continuing

---

## ğŸ”— Related

- Previous: [v0.4.4 - Unified Cache System](v0.4.4.md)
- Architecture: `src/layer-c-memory/mcp/` directory
- Docs: See `ARCHITECTURE.md` for full system design
